<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OceanPulse - Advanced Ocean Plastic Intelligence Platform</title>
    
    <!-- MapLibre GL JS -->
    <link href='https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js'></script>


    
    <!-- Apache ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- Turf.js for geospatial calculations -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --navy-dark: #0a0e27;
            --navy-light: #1a2947;
            --teal-primary: #4FD1C5;
            --teal-light: #81E6D9;
            --warning: #ffd93d;
            --danger: #ff6b6b;
            --text-primary: #e0e6f0;
            --text-secondary: #a0aec0;
            --border-color: rgba(79, 209, 197, 0.2);
            --glass-bg: rgba(30, 41, 59, 0.6);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy-light) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Navigation */
        nav {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }
        
        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--teal-primary), var(--teal-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--teal-primary);
            background: rgba(79, 209, 197, 0.1);
        }
        
        /* Main Container */
        .container {
            padding-top: 80px;
            min-height: 100vh;
        }
        
        /* Dashboard Section */
        .dashboard {
            display: none;
            padding: 1rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .dashboard.active {
            display: block;
        }
        
        /* Search Box */
        .search-container {
            position: absolute;
            top: 90px;
            left: 20px;
            z-index: 500;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
        }
        
        .search-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 0.5rem;
            width: 250px;
            outline: none;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }
        
        .search-result {
            padding: 0.5rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .search-result:hover {
            background: rgba(79, 209, 197, 0.1);
        }
        
        /* Metrics Row */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .metric-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            transition: transform 0.3s, border-color 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            border-color: rgba(79, 209, 197, 0.4);
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--teal-primary);
            margin-bottom: 0.3rem;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-delta {
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }
        
        .delta-positive { color: var(--danger); }
        .delta-negative { color: var(--teal-primary); }
        
        /* Map Container */
        #map {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            margin-bottom: 1rem;
        }
        
        /* Layer Panel */
        .layer-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 400;
        }
        
        .panel-title {
            color: var(--teal-primary);
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            cursor: pointer;
        }
        
        .layer-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 0.8rem;
            cursor: pointer;
        }
        
        .layer-label {
            color: var(--text-primary);
            font-size: 0.9rem;
            flex: 1;
        }
        
        .layer-icon {
            width: 20px;
            height: 20px;
            margin-left: 0.5rem;
        }
        
        /* Legend Panel */
        .legend-panel {
            position: absolute;
            bottom: 120px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            z-index: 400;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .legend-symbol {
            width: 30px;
            height: 20px;
            margin-right: 0.8rem;
            border-radius: 4px;
        }
        
        /* Filter Chips */
        .filter-container {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        
        .filter-chip {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 0.4rem 1rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .filter-chip:hover {
            background: rgba(79, 209, 197, 0.1);
            border-color: var(--teal-primary);
        }
        
        .filter-chip.active {
            background: var(--teal-primary);
            color: var(--navy-dark);
            border-color: var(--teal-primary);
        }
        
        /* Time Slider */
        .time-slider-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            width: 600px;
            z-index: 400;
        }
        
        .time-slider {
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .play-button {
            background: var(--teal-primary);
            color: var(--navy-dark);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }
        
        .play-button:hover {
            transform: scale(1.1);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--navy-light) 0%, var(--navy-dark) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .modal-title {
            font-size: 1.8rem;
            color: var(--teal-primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--teal-primary);
        }
        
        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .chart-container {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
        }
        
        .sankey-container {
            grid-column: 1 / -1;
            height: 400px;
        }
        
        /* Scenario Selector */
        .scenario-selector {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            justify-content: center;
        }
        
        .scenario-btn {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .scenario-btn:hover {
            background: rgba(79, 209, 197, 0.1);
            border-color: var(--teal-primary);
        }
        
        .scenario-btn.active {
            background: var(--teal-primary);
            color: var(--navy-dark);
            border-color: var(--teal-primary);
        }
        
        /* Right Drawer */
        .right-drawer {
            position: fixed;
            right: -350px;
            top: 80px;
            width: 350px;
            height: calc(100vh - 80px);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-left: 1px solid var(--border-color);
            transition: right 0.3s;
            z-index: 900;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .right-drawer.open {
            right: 0;
        }
        
        .drawer-toggle {
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--teal-primary);
            color: var(--navy-dark);
            border: none;
            border-radius: 8px 0 0 8px;
            padding: 0.8rem 0.5rem;
            cursor: pointer;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        /* Popup Styles */
        .maplibregl-popup-content {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 1rem;
            max-width: 350px;
        }
        
        .maplibregl-popup-close-button {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        .popup-title {
            color: var(--teal-primary);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .popup-content {
            font-size: 0.9rem;
        }
        
        .popup-chart {
            height: 100px;
            margin-top: 0.5rem;
        }
        
        /* Other Sections (keep existing styles) */
        .consulting, .data-packages, .industry, .heatmap-dashboard, .about {
            display: none;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .consulting.active, .data-packages.active, .industry.active, .heatmap-dashboard.active, .about.active {
            display: block;
        }
        
        /* Heatmap Dashboard Styles */
        .heatmap-container {
            padding: 0;
            max-width: 100%;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: 1rem;
        }
        
        .heatmap-panel {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            overflow: auto;
            max-height: calc(100vh - 120px);
        }
        
        .heatmap-section {
            margin-bottom: 1rem;
        }
        
        .heatmap-section h3 {
            margin: 0 0 0.5rem;
            font-size: 0.9rem;
            color: var(--teal-light);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .heatmap-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .heatmap-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .heatmap-chips .chip {
            background: rgba(21, 29, 63, 0.9);
            border: 1px solid var(--border-color);
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            font-size: 0.85rem;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        
        .heatmap-chips .chip.active {
            outline: 1px solid var(--teal-primary);
            background: linear-gradient(180deg, #1a254d, #0f193a);
        }
        
        .heatmap-layer-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .heatmap-layer-list label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        
        .heatmap-legend {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .heatmap-legend .sw {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            display: inline-block;
            margin-right: 0.3rem;
        }
        
        .heatmap-kpis {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        
        .heatmap-kpis .kpi {
            background: rgba(16, 24, 58, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.6rem;
        }
        
        .heatmap-kpis .kpi .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .heatmap-kpis .kpi .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--teal-primary);
        }
        
        .heatmap-footer {
            margin-top: 1.5rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--teal-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .metrics-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .time-slider-container {
                width: 90%;
            }
            
            .layer-panel {
                top: auto;
                bottom: 140px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-container {
                flex-direction: column;
            }
            
            /* Navigation responsive */
            .nav-links {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .nav-link {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }
            
            /* Consulting responsive */
            .hero-content {
                grid-template-columns: 1fr;
            }
            
            .flow-steps {
                flex-direction: column;
            }
            
            .flow-connector {
                width: 2px;
                height: 40px;
                margin: 0 auto;
            }
            
            /* Data Packages responsive */
            .catalog-layout {
                grid-template-columns: 1fr;
            }
            
            .filters-sidebar {
                position: static;
                margin-bottom: 2rem;
            }
            
            /* Industry Solutions responsive */
            .segment-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .segment-pill {
                width: 100%;
            }
            
            .pathway-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pathway-arrow {
                transform: rotate(90deg);
                margin: 1rem auto;
            }
            
            .roi-container {
                grid-template-columns: 1fr;
            }
            
            .bundles-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Custom Map Controls */
        .maplibregl-ctrl-group {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }
        
        .maplibregl-ctrl-group button {
            background: transparent;
            color: var(--text-primary);
        }
        
        .maplibregl-ctrl-group button:hover {
            background: rgba(79, 209, 197, 0.1);
        }
        
        /* ========== Consulting Service Styles ========== */
        
        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, rgba(79, 209, 197, 0.1) 0%, rgba(26, 41, 71, 0.2) 100%);
            border-radius: 16px;
            padding: 3rem;
            margin-bottom: 3rem;
        }
        
        .hero-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            align-items: center;
        }
        
        .hero-title {
            font-size: 2.5rem;
            color: var(--teal-primary);
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .cta-button {
            background: linear-gradient(135deg, var(--teal-primary) 0%, var(--teal-light) 100%);
            color: var(--navy-dark);
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 209, 197, 0.3);
        }
        
        .checklist {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 1.2rem;
            animation: slideInRight 0.5s ease-out forwards;
            opacity: 0;
        }
        
        .checklist-item:nth-child(1) { animation-delay: 0.1s; }
        .checklist-item:nth-child(2) { animation-delay: 0.2s; }
        .checklist-item:nth-child(3) { animation-delay: 0.3s; }
        .checklist-item:nth-child(4) { animation-delay: 0.4s; }
        .checklist-item:nth-child(5) { animation-delay: 0.5s; }
        
        @keyframes slideInRight {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .check-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--teal-primary);
            color: var(--navy-dark);
            border-radius: 50%;
            margin-right: 1rem;
            font-weight: bold;
        }
        
        /* Service Tiers */
        .service-tiers {
            margin-bottom: 4rem;
        }
        
        .tiers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .tier-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            position: relative;
            transition: transform 0.3s, border-color 0.3s;
        }
        
        .tier-card:hover {
            transform: translateY(-5px);
            border-color: var(--teal-primary);
        }
        
        .tier-card.featured {
            border-color: var(--teal-primary);
            box-shadow: 0 0 30px rgba(79, 209, 197, 0.2);
        }
        
        .tier-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--warning);
            color: var(--navy-dark);
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .tier-name {
            font-size: 1.5rem;
            color: var(--teal-primary);
            margin-bottom: 0.5rem;
        }
        
        .tier-duration {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .tier-price {
            font-size: 1.8rem;
            color: var(--warning);
            margin-bottom: 1.5rem;
            font-weight: bold;
        }
        
        .tier-deliverables {
            list-style: none;
            margin-bottom: 2rem;
        }
        
        .tier-deliverables li {
            padding: 0.5rem 0;
            color: var(--text-primary);
            position: relative;
            padding-left: 1.5rem;
        }
        
        .tier-deliverables li:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: var(--teal-primary);
        }
        
        /* Engagement Flow */
        .engagement-flow {
            margin-bottom: 4rem;
        }
        
        .flow-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            overflow-x: auto;
            padding: 2rem 0;
        }
        
        .flow-step {
            flex: 0 0 auto;
            text-align: center;
            position: relative;
        }
        
        .step-number {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            color: var(--navy-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto 1rem;
        }
        
        .step-title {
            color: var(--teal-primary);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .step-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
            max-width: 120px;
        }
        
        .flow-connector {
            flex: 0 0 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--teal-primary), var(--teal-light));
            margin: 0 -10px;
            align-self: center;
            margin-bottom: 3rem;
        }
        
        /* Case Studies */
        .case-studies {
            margin-bottom: 4rem;
        }
        
        .studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .case-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .case-card:hover {
            transform: translateY(-3px);
            border-color: var(--teal-primary);
            box-shadow: 0 10px 30px rgba(79, 209, 197, 0.2);
        }
        
        .case-sector {
            display: inline-block;
            background: rgba(79, 209, 197, 0.2);
            color: var(--teal-light);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .case-title {
            color: var(--teal-primary);
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .case-kpis {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .kpi-item {
            text-align: center;
        }
        
        .kpi-value {
            color: var(--warning);
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .kpi-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        /* Expert Panel */
        .expert-panel {
            margin-bottom: 4rem;
        }
        
        .experts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .expert-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .expert-card:hover {
            transform: translateY(-3px);
        }
        
        .expert-avatar {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .expert-card h3 {
            color: var(--teal-primary);
            margin-bottom: 0.5rem;
        }
        
        .expert-role {
            color: var(--warning);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .expert-bio {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .credibility-logos {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        .logo-placeholder {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            padding: 1rem 2rem;
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: bold;
        }
        
        /* Intake Form Wizard */
        .intake-section {
            margin-bottom: 4rem;
        }
        
        .wizard-container {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            margin: 2rem auto;
        }
        
        .wizard-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 3rem;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .progress-step.active .step-dot {
            background: var(--teal-primary);
            color: var(--navy-dark);
        }
        
        .progress-step.completed .step-dot {
            background: var(--teal-light);
            color: var(--navy-dark);
        }
        
        .step-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .step-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .progress-line {
            width: 100px;
            height: 2px;
            background: var(--border-color);
            margin: 0 1rem;
            margin-bottom: 2rem;
        }
        
        .wizard-step {
            display: none;
        }
        
        .wizard-step.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .wizard-step h3 {
            color: var(--teal-primary);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--teal-primary);
            box-shadow: 0 0 0 3px rgba(79, 209, 197, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }
        
        .wizard-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        .wizard-btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .wizard-btn.prev {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .wizard-btn.next,
        .wizard-btn.submit {
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            color: var(--navy-dark);
        }
        
        .wizard-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Thank You Message */
        .thank-you-message {
            text-align: center;
            padding: 3rem;
            background: var(--glass-bg);
            border: 1px solid var(--teal-primary);
            border-radius: 12px;
            max-width: 600px;
            margin: 2rem auto;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            color: var(--navy-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 2rem;
        }
        
        #leadScore {
            font-size: 2rem;
            color: var(--warning);
            font-weight: bold;
        }
        
        #leadMessage {
            color: var(--text-secondary);
            margin: 1rem 0 2rem;
        }
        
        /* FAQ Section */
        .faq-section {
            margin-bottom: 4rem;
        }
        
        .faq-container {
            max-width: 800px;
            margin: 2rem auto;
        }
        
        .faq-item {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .faq-question {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .faq-question:hover {
            background: rgba(79, 209, 197, 0.05);
        }
        
        .faq-toggle {
            color: var(--teal-primary);
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        
        .faq-item.open .faq-toggle {
            transform: rotate(45deg);
        }
        
        .faq-answer {
            padding: 0 1.5rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s;
            color: var(--text-secondary);
        }
        
        .faq-item.open .faq-answer {
            padding: 0 1.5rem 1.5rem;
            max-height: 500px;
        }
        
        /* Calendar Modal Styles */
        .calendar-container {
            padding: 1rem;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .slot-day {
            text-align: center;
        }
        
        .slot-date {
            color: var(--teal-primary);
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .time-slot {
            display: block;
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .time-slot:hover {
            background: rgba(79, 209, 197, 0.1);
            border-color: var(--teal-primary);
        }
        
        .time-slot.selected {
            background: var(--teal-primary);
            color: var(--navy-dark);
            border-color: var(--teal-primary);
        }
        
        .contact-info .form-group {
            margin-bottom: 1rem;
        }
        
        /* === Data Packages (scoped) === */
        #data-packages .dp-layout{display:grid;grid-template-columns:280px 1fr;gap:1rem;align-items:start}
        #data-packages .dp-sticky{position:sticky;top:96px}
        #data-packages .dp-h3{font-size:.95rem;color:var(--teal-primary);margin-bottom:.6rem}
        #data-packages .filter-block{margin-bottom:1rem}
        #data-packages .filter-title{font-size:.8rem;color:var(--text-secondary);margin-bottom:.35rem;text-transform:uppercase;letter-spacing:.12em}
        #data-packages .dp-toolbar{display:flex;justify-content:space-between;gap:.5rem;align-items:center;margin-bottom:.6rem}
        #data-packages .search{flex:1;background:transparent;border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);padding:.55rem .7rem}
        #data-packages .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
        #data-packages .pkg{display:flex;flex-direction:column;gap:.5rem}
        #data-packages .pkg h4{font-size:1rem}
        #data-packages .badge{display:inline-block;padding:.15rem .5rem;border-radius:6px;border:1px solid var(--border-color);font-size:.75rem;color:var(--text-secondary)}
        #data-packages .pkg-actions{display:flex;gap:.5rem;flex-wrap:wrap}
        #data-packages .btn{background:transparent;border:1px solid var(--border-color);color:var(--teal-primary);padding:.45rem .7rem;border-radius:8px;cursor:pointer}
        #data-packages .btn:hover{background:rgba(79,209,197,.12)}
        #data-packages .preview{height:120px;border-radius:8px;border:1px solid var(--border-color)}
        #data-packages .inline{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
        #data-packages .dp-sep{height:1px;background:var(--border-color);margin:.6rem 0}

        /* Chips */
        #data-packages .chips{display:flex;gap:.5rem;flex-wrap:wrap}
        #data-packages .chips .chip{background:var(--glass-bg);border:1px solid var(--border-color);padding:.35rem .8rem;border-radius:999px;font-size:.85rem;color:var(--text-primary);cursor:pointer}
        #data-packages .chips .chip.active{background:var(--teal-primary);color:#06202a;border-color:transparent}

        /* Pricing Drawer / Modals */
        #dpDrawerToggle{position:fixed;right:10px;top:50%;transform:translateY(-50%);background:var(--teal-primary);color:#06202a;border:none;border-radius:8px;padding:.35rem .6rem;font-size:.8rem;line-height:1;cursor:pointer;z-index:901;box-shadow:0 2px 8px rgba(0,0,0,.25);left:auto !important;width:auto;display:inline-block}
        @media (max-width: 980px){ #dpDrawerToggle{position:fixed;right:10px;top:50%;transform:translateY(-50%);background:var(--teal-primary);color:#06202a;border:none;border-radius:8px;padding:.35rem .6rem;font-size:.8rem;line-height:1;cursor:pointer;z-index:901;box-shadow:0 2px 8px rgba(0,0,0,.25);left:auto !important;width:auto;display:inline-block} }
        #pricingDrawer{position:fixed;right:0;top:80px;width:320px;height:calc(100vh - 80px);padding:1rem;border-left:1px solid var(--border-color);background:var(--glass-bg);backdrop-filter:blur(10px);transform:translateX(100%);transition:transform .25s;z-index:900}
        #pricingDrawer.open{transform:translateX(0)}
        #pricingDrawer .select,#pricingDrawer .input{width:100%;background:transparent;border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);padding:.5rem}
        #schemaModal,#quoteModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1001}
        #schemaModal.show,#quoteModal.show{display:flex}
        #schemaModal .modal-content,#quoteModal .modal-content{background:var(--glass-bg);border:1px solid var(--border-color);border-radius:12px}
        
        /* ========== About Page Styles ========== */
        .about-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem 4rem;
        }
        
        .about-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .about-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--teal-primary);
        }
        
        .about-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .about-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 2.5rem;
            margin-bottom: 3rem;
        }

        .about-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--text-primary);
        }
        
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 2.5rem;
            justify-items: center;
            text-align: center;
        }

        .team-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem 1.5rem;
            max-width: 320px;
            box-shadow: 0 18px 45px rgba(10, 14, 39, 0.45);
        }

        .team-photo {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            border: 3px solid rgba(79, 209, 197, 0.35);
            box-shadow: 0 0 25px rgba(129, 230, 217, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.9rem;
            font-weight: 600;
            color: var(--teal-light);
            background: radial-gradient(circle at 30% 30%, rgba(129, 230, 217, 0.45), rgba(23, 32, 61, 0.8));
            position: relative;
            overflow: hidden;
        }

        .team-photo[data-initials]::after {
            content: attr(data-initials);
        }

        .team-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .team-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .team-name-cn {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 0.8rem;
        }

        .team-role {
            font-size: 1.05rem;
            margin-bottom: 0.35rem;
        }

        .team-role-cn {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .team-affiliation {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .team-affiliation-cn {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .about-container {
                padding: 1.5rem 1rem 3rem;
            }

            .about-title {
                font-size: 2.1rem;
            }

            .about-logos {
                gap: 1.5rem;
            }
        }
        
        /* ========== Industry Solutions Styles ========== */
        
        .industry-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .industry-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        /* Segment Selector */
        .segment-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 3rem;
        }
        
        .segment-pill {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 1rem 2rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .segment-pill:hover {
            border-color: var(--teal-primary);
            transform: translateY(-2px);
        }
        
        .segment-pill.active {
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            color: var(--navy-dark);
            border-color: var(--teal-primary);
        }
        
        .segment-icon {
            font-size: 1.5rem;
        }
        
        /* Bundles Section */
        .bundles-section {
            margin-bottom: 4rem;
        }
        
        .bundles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 2rem;
        }
        
        .bundle-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            position: relative;
            transition: all 0.3s;
        }
        
        .bundle-card:hover {
            transform: translateY(-5px);
            border-color: var(--teal-primary);
            box-shadow: 0 15px 40px rgba(79, 209, 197, 0.2);
        }
        
        .bundle-card.featured {
            border-color: var(--warning);
        }
        
        .bundle-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .bundle-name {
            font-size: 1.5rem;
            color: var(--teal-primary);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .bundle-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .bundle-metrics {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(79, 209, 197, 0.05);
            border-radius: 8px;
        }
        
        .metric-name {
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .metric-value {
            color: var(--warning);
            font-weight: bold;
        }
        
        .bundle-outcomes {
            margin-bottom: 1.5rem;
        }
        
        .outcome-item {
            color: var(--text-secondary);
            padding: 0.3rem 0;
            font-size: 0.9rem;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .outcome-item:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--teal-primary);
        }
        
        .bundle-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .bundle-btn {
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            text-align: center;
        }
        
        .bundle-btn.primary {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            color: var(--navy-dark);
            border: none;
        }
        
        .bundle-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 209, 197, 0.3);
        }
        
        .bundle-btn.secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .bundle-btn.secondary:hover {
            background: rgba(79, 209, 197, 0.1);
            border-color: var(--teal-primary);
        }
        
        /* Outcome Pathways */
        .outcome-pathways {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            margin-bottom: 4rem;
        }
        
        .pathway-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            overflow-x: auto;
            padding: 2rem 0;
        }
        
        .pathway-stage {
            text-align: center;
            flex: 0 0 auto;
            padding: 1.5rem;
            background: rgba(79, 209, 197, 0.05);
            border-radius: 12px;
            min-width: 150px;
        }
        
        .pathway-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .pathway-label {
            color: var(--teal-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .pathway-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .pathway-arrow {
            font-size: 2rem;
            color: var(--teal-primary);
            margin: 0 1rem;
        }
        
        /* Playbooks */
        .playbooks-section {
            margin-bottom: 4rem;
        }
        
        .playbooks-accordion {
            max-width: 900px;
            margin: 2rem auto;
        }
        
        .playbook-item {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .playbook-header {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .playbook-header:hover {
            background: rgba(79, 209, 197, 0.05);
        }
        
        .playbook-toggle {
            color: var(--teal-primary);
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        
        .playbook-item.open .playbook-toggle {
            transform: rotate(45deg);
        }
        
        .playbook-content {
            padding: 0 1.5rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s;
        }
        
        .playbook-item.open .playbook-content {
            padding: 0 1.5rem 1.5rem;
            max-height: 800px;
        }
        
        .playbook-content h4 {
            color: var(--teal-light);
            margin: 1rem 0 0.5rem;
        }
        
        .playbook-content ul,
        .playbook-content ol {
            color: var(--text-secondary);
            margin-left: 1.5rem;
            line-height: 1.8;
        }
        
        /* ROI Calculator */
        .roi-section {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            margin-bottom: 4rem;
        }
        
        .roi-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-top: 2rem;
        }
        
        .roi-inputs h3,
        .roi-outputs h3 {
            color: var(--teal-light);
            margin-bottom: 1.5rem;
        }
        
        .roi-form .form-group {
            margin-bottom: 1rem;
        }
        
        .roi-form input {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.8rem;
            border-radius: 8px;
        }
        
        .roi-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .roi-metric {
            text-align: center;
            padding: 1rem;
            background: rgba(79, 209, 197, 0.05);
            border-radius: 8px;
        }
        
        .roi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--warning);
            margin-bottom: 0.5rem;
        }
        
        .roi-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        
        #roiChart {
            width: 100%;
            height: 200px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
        }
        
        /* RFQ Section */
        .rfq-section {
            margin-bottom: 4rem;
        }
        
        .rfq-wizard {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            max-width: 1000px;
            margin: 2rem auto;
        }
        
        .rfq-step {
            display: none;
        }
        
        .rfq-step.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .rfq-step h3 {
            color: var(--teal-primary);
            margin-bottom: 2rem;
        }
        
        .bundle-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .bundle-option {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .bundle-option:hover {
            border-color: var(--teal-primary);
        }
        
        .bundle-option.selected {
            border-color: var(--teal-primary);
            background: rgba(79, 209, 197, 0.1);
        }
        
        .addon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .addon-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .addon-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .addon-info {
            flex: 1;
        }
        
        .addon-name {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .addon-price {
            color: var(--warning);
            font-size: 0.9rem;
        }
        
        .deployment-options .form-group,
        .contact-form .form-group {
            margin-bottom: 1.5rem;
        }
        
        .deployment-options select,
        .contact-form input,
        .contact-form textarea {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.8rem;
            border-radius: 8px;
        }
        
        .rfq-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        
        .rfq-btn {
            padding: 0.8rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .rfq-btn.prev {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .rfq-btn.next,
        .rfq-btn.submit {
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            color: var(--navy-dark);
            border: none;
        }
        
        .rfq-btn:hover {
            transform: translateY(-2px);
        }
        
        .rfq-summary {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(79, 209, 197, 0.05);
            border-radius: 8px;
        }
        
        .rfq-summary h3 {
            color: var(--teal-primary);
            margin-bottom: 1rem;
        }
        
        /* Case Examples */
        .case-examples {
            margin-bottom: 4rem;
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .example-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }
        
        .example-card:hover {
            transform: translateY(-3px);
            border-color: var(--teal-primary);
        }
        
        .example-org {
            color: var(--teal-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .example-result {
            color: var(--warning);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .example-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        /* Telemetry Modal */
        .telemetry-content h3 {
            color: var(--teal-primary);
            margin-bottom: 1rem;
        }
        
        .telemetry-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: rgba(79, 209, 197, 0.05);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .telemetry-stat span:first-child {
            color: var(--text-primary);
        }
        
        .telemetry-stat span:last-child {
            color: var(--warning);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo" onclick="Navigation.navigateTo('dashboard')">ðŸŒŠ OceanPulse</div>
            <div class="nav-links">
                <a class="nav-link active" onclick="Navigation.navigateTo('dashboard')">Dashboard</a>
                <a class="nav-link" onclick="Navigation.navigateTo('heatmap-dashboard')">Heatmap</a>
                <a class="nav-link" onclick="Navigation.navigateTo('consulting')">Consulting Service</a>
                <a class="nav-link" onclick="Navigation.navigateTo('data-packages')">Data Packages</a>
                <a class="nav-link" onclick="Navigation.navigateTo('industry')">Industry Solutions</a>
                <a class="nav-link" onclick="Navigation.navigateTo('about')">About Us</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Advanced Dashboard Section -->
        <div class="dashboard active" id="dashboard">
            <!-- KPI Metrics -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-value" id="totalInput">2,145</div>
                    <div class="metric-label">Total Input (tons/mo)</div>
                    <div class="metric-delta delta-positive">â–² 12% vs last year</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="retentionRate">68%</div>
                    <div class="metric-label">Retention Rate</div>
                    <div class="metric-delta delta-negative">â–¼ 3% improvement</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="exportAmount">687</div>
                    <div class="metric-label">Export to Ocean (tons)</div>
                    <div class="metric-delta delta-positive">â–² 8% vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="dominantSource">Packaging</div>
                    <div class="metric-label">Dominant Source</div>
                    <div class="metric-delta">40% of total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="dominantPlastic">PE</div>
                    <div class="metric-label">Dominant Plastic</div>
                    <div class="metric-delta">35% of total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="riskIndex">72</div>
                    <div class="metric-label">Risk Index</div>
                    <div class="metric-delta delta-positive">â–² High Risk</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filter-container">
                <div class="filter-group">
                    <span class="filter-label">Plastic Type:</span>
                    <span class="filter-chip" data-type="plastic" data-value="PE">PE</span>
                    <span class="filter-chip" data-type="plastic" data-value="PP">PP</span>
                    <span class="filter-chip" data-type="plastic" data-value="PET">PET</span>
                    <span class="filter-chip" data-type="plastic" data-value="PS">PS</span>
                    <span class="filter-chip" data-type="plastic" data-value="PVC">PVC</span>
                    <span class="filter-chip" data-type="plastic" data-value="Fibers">Fibers</span>
                    <span class="filter-chip" data-type="plastic" data-value="TireWear">Tire Wear</span>
                    <span class="filter-chip" data-type="plastic" data-value="Mixed">Mixed</span>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Source:</span>
                    <span class="filter-chip" data-type="source" data-value="Packaging">Packaging</span>
                    <span class="filter-chip" data-type="source" data-value="Textiles">Textiles</span>
                    <span class="filter-chip" data-type="source" data-value="Industrial">Industrial</span>
                    <span class="filter-chip" data-type="source" data-value="Fisheries">Fisheries</span>
                    <span class="filter-chip" data-type="source" data-value="UrbanRunoff">Urban Runoff</span>
                    <span class="filter-chip" data-type="source" data-value="Maritime">Maritime</span>
                </div>
            </div>

            <!-- Scenario Selector -->
            <div class="scenario-selector">
                <button class="scenario-btn active" data-scenario="baseline">Baseline</button>
                <button class="scenario-btn" data-scenario="wet">Wet Season</button>
                <button class="scenario-btn" data-scenario="control">Control Policy</button>
            </div>

            <!-- Map Container -->
            <div style="position: relative;">
                <div id="map"></div>
                
                <!-- Search Box -->
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search locations..." id="searchInput">
                    <div class="search-results" id="searchResults"></div>
                </div>
                
                <!-- Layer Panel -->
                <div class="layer-panel">
                    <div class="panel-title">Map Layers</div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-regulatory" checked>
                        <label class="layer-label" for="layer-regulatory">Regulatory Hotspots</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-fisheries">
                        <label class="layer-label" for="layer-fisheries">Fisheries</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-wwtp" checked>
                        <label class="layer-label" for="layer-wwtp">Wastewater & Outfalls</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-industrial">
                        <label class="layer-label" for="layer-industrial">Industrial & Ports</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-tourism">
                        <label class="layer-label" for="layer-tourism">Tourism & Beaches</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-monitoring">
                        <label class="layer-label" for="layer-monitoring">Monitoring Stations</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-heatmap">
                        <label class="layer-label" for="layer-heatmap">Concentration Heatmap</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-currents">
                        <label class="layer-label" for="layer-currents">Wind/Currents</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" id="layer-shipping" checked>
                        <label class="layer-label" for="layer-shipping">Shipping Lanes</label>
                    </div>
                </div>
                
                <!-- Legend Panel -->
                <div class="legend-panel">
                    <div class="panel-title">Legend</div>
                    <!-- Dynamically populated by Legend module -->
                </div>
                
                <!-- Time Slider -->
                <div class="time-slider-container">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="play-button" id="playButton">â–¶</button>
                        <input type="range" class="time-slider" id="timeSlider" min="0" max="35" value="35" style="flex: 1; margin: 0 1rem;">
                        <span id="currentMonth" style="min-width: 100px; text-align: right;">Oct 2025</span>
                    </div>
                    <div class="time-display">
                        <span style="color: var(--text-secondary);">Jan 2023</span>
                        <span style="color: var(--teal-primary);">Real-time Mode</span>
                        <span style="color: var(--text-secondary);">Oct 2025</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid" style="margin-top: 1rem;">
                <div class="chart-container">
                    <div id="inputTrendChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="chart-container">
                    <div id="riskIndexChart" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Heatmap Dashboard Section -->
        <div class="heatmap-dashboard" id="heatmap-dashboard">
            <div class="heatmap-container">
                <div class="heatmap-grid">
                    <div id="heatmapMap" style="width: 100%; height: calc(100vh - 120px); border-radius: 12px; border: 1px solid var(--border-color);"></div>
                    <aside class="heatmap-panel">
                        <div class="heatmap-section">
                            <h3>Filters</h3>
                            <div class="heatmap-row">
                                <input type="text" id="heatmapSearch" placeholder="Search POIsâ€¦" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid var(--border-color);background:var(--glass-bg);color:var(--text-primary)"/>
                                <button class="btn" id="heatmapResetBtn">Reset</button>
                            </div>
                            <div class="heatmap-row" style="margin-top:8px">
                                <div class="heatmap-chips" id="heatmapPlasticChips"></div>
                            </div>
                            <div class="heatmap-row" style="margin-top:6px">
                                <span class="small">Scenario:</span>
                                <button class="tab active" data-scenario="baseline">Baseline</button>
                                <button class="tab" data-scenario="wet">Wet season</button>
                                <button class="tab" data-scenario="control">Control policy</button>
                            </div>
                        </div>

                        <div class="heatmap-section">
                            <h3>Layers</h3>
                            <div class="heatmap-layer-list" id="heatmapLayerList"></div>
                            <div class="heatmap-legend" id="heatmapLegend">
                                <div><span class="sw" style="background:#3dd2a3"></span>WWTP / Outfalls</div>
                                <div><span class="sw" style="background:#ffd93d"></span>Industrial / Ports</div>
                                <div><span class="sw" style="background:#6ea8ff"></span>Fisheries</div>
                                <div><span class="sw" style="background:#ff6b6b"></span>Regulatory redline</div>
                            </div>
                        </div>

                        <div class="heatmap-section">
                            <h3>Time</h3>
                            <div class="card">
                                <div class="heatmap-row" style="justify-content:space-between"><span class="small">Month:</span><span id="heatmapMonthLabel">2025-01</span></div>
                                <input type="range" id="heatmapTimeSlider" min="0" max="35" value="35" aria-label="Time slider"/>
                                <div class="heatmap-row" style="justify-content:space-between">
                                    <span class="small">Historic (âˆ’36m)</span><span class="small">Real-time</span>
                                </div>
                            </div>
                        </div>

                        <div class="heatmap-section">
                            <h3>KPIs</h3>
                            <div class="heatmap-kpis">
                                <div class="kpi"><div class="label">Total Input (t/mo)</div><div class="value" id="heatmapKpiInput">â€“</div></div>
                                <div class="kpi"><div class="label">Retention %</div><div class="value" id="heatmapKpiRetention">â€“</div></div>
                                <div class="kpi"><div class="label">Export (t/mo)</div><div class="value" id="heatmapKpiExport">â€“</div></div>
                                <div class="kpi"><div class="label">Dominant Source</div><div class="value" id="heatmapKpiSource">â€“</div></div>
                                <div class="kpi"><div class="label">Top Plastic</div><div class="value" id="heatmapKpiPlastic">â€“</div></div>
                            </div>
                        </div>

                        <div class="heatmap-section">
                            <h3>Charts</h3>
                            <div class="card"><div id="heatmapTsChart" style="height:180px"></div></div>
                            <div class="card" style="margin-top:8px"><div id="heatmapRiskChart" style="height:140px"></div></div>
                            <div class="card" style="margin-top:8px"><div id="heatmapSankeyChart" style="height:240px"></div></div>
                            <div class="heatmap-row" style="gap:8px;margin-top:8px">
                                <button class="btn" id="heatmapDlCsv">Download visible CSV</button>
                                <button class="btn" id="heatmapSavePng">Save charts as PNG</button>
                            </div>
                        </div>
                    </aside>
                </div>
                <div class="heatmap-footer small">Demo mock data Â· Map style Â© MapLibre demo Â· Charts Â© Apache ECharts</div>
            </div>
        </div>

        <!-- Consulting Service Section -->
        <div class="consulting" id="consulting">
            <!-- Hero Section -->
            <div class="hero-section">
                <div class="hero-content">
                    <div class="hero-left">
                        <h1 class="hero-title">Microplastics Risk & MFA Advisory</h1>
                        <p class="hero-subtitle">Transform your ocean plastic data into actionable intelligence with our expert consulting services</p>
                        <button class="cta-button" onclick="scrollToIntake()">Start Your Assessment</button>
                    </div>
                    <div class="hero-right">
                        <div class="checklist">
                            <div class="checklist-item">
                                <span class="check-icon">âœ“</span>
                                <span>ISO 14001 Certified Methodology</span>
                            </div>
                            <div class="checklist-item">
                                <span class="check-icon">âœ“</span>
                                <span>25+ Successful Bay Assessments</span>
                            </div>
                            <div class="checklist-item">
                                <span class="check-icon">âœ“</span>
                                <span>Real-time Data Integration</span>
                            </div>
                            <div class="checklist-item">
                                <span class="check-icon">âœ“</span>
                                <span>Policy-Ready Reporting</span>
                            </div>
                            <div class="checklist-item">
                                <span class="check-icon">âœ“</span>
                                <span>ROI Within 6 Months</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Tiers -->
            <section class="service-tiers">
                <h2 class="section-title">Service Offerings</h2>
                <div class="tiers-grid" id="tiersGrid">
                    <!-- Dynamically populated -->
                </div>
            </section>

            <!-- Engagement Flow -->
            <section class="engagement-flow">
                <h2 class="section-title">Our Engagement Process</h2>
                <div class="flow-steps">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-title">Kick-off</div>
                        <div class="step-desc">Stakeholder alignment & data requirements</div>
                    </div>
                    <div class="flow-connector"></div>
                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-title">Data Ingestion</div>
                        <div class="step-desc">Collect & validate source data</div>
                    </div>
                    <div class="flow-connector"></div>
                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-title">Modeling</div>
                        <div class="step-desc">MFA & risk assessment</div>
                    </div>
                    <div class="flow-connector"></div>
                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-title">Validation</div>
                        <div class="step-desc">Field verification & QA/QC</div>
                    </div>
                    <div class="flow-connector"></div>
                    <div class="flow-step">
                        <div class="step-number">5</div>
                        <div class="step-title">Reporting</div>
                        <div class="step-desc">Insights & recommendations</div>
                    </div>
                    <div class="flow-connector"></div>
                    <div class="flow-step">
                        <div class="step-number">6</div>
                        <div class="step-title">Handover</div>
                        <div class="step-desc">Training & implementation</div>
                    </div>
                </div>
            </section>

            <!-- Case Studies -->
            <section class="case-studies">
                <h2 class="section-title">Success Stories</h2>
                <div class="studies-grid" id="caseStudiesGrid">
                    <!-- Dynamically populated -->
                </div>
            </section>

            <!-- Expert Panel -->
            <section class="expert-panel">
                <h2 class="section-title">Our Expert Team</h2>
                <div class="experts-grid">
                    <div class="expert-card">
                        <div class="expert-avatar">ðŸ‘¨â€ðŸ”¬</div>
                        <h3>Dr. James Chen</h3>
                        <p class="expert-role">Lead MFA Scientist</p>
                        <p class="expert-bio">15+ years in marine pollution modeling</p>
                    </div>
                    <div class="expert-card">
                        <div class="expert-avatar">ðŸ‘©â€ðŸ’¼</div>
                        <h3>Sarah Martinez</h3>
                        <p class="expert-role">Policy Advisor</p>
                        <p class="expert-bio">Former UN Ocean Treaty negotiator</p>
                    </div>
                    <div class="expert-card">
                        <div class="expert-avatar">ðŸ‘¨â€ðŸ’»</div>
                        <h3>Dr. Wei Zhang</h3>
                        <p class="expert-role">Data Science Lead</p>
                        <p class="expert-bio">ML specialist in environmental data</p>
                    </div>
                    <div class="expert-card">
                        <div class="expert-avatar">ðŸ‘©â€ðŸ”¬</div>
                        <h3>Dr. Lisa Wong</h3>
                        <p class="expert-role">Field Operations</p>
                        <p class="expert-bio">200+ field sampling campaigns</p>
                    </div>
                </div>
                <div class="credibility-logos">
                    <span class="logo-placeholder">ISO 14001</span>
                    <span class="logo-placeholder">UNEP</span>
                    <span class="logo-placeholder">IUCN</span>
                    <span class="logo-placeholder">WWF Partner</span>
                </div>
            </section>

            <!-- Intake Form Wizard -->
            <section class="intake-section" id="intakeSection">
                <h2 class="section-title">Request Consultation</h2>
                <div class="wizard-container">
                    <div class="wizard-progress">
                        <div class="progress-step active" data-step="1">
                            <span class="step-dot">1</span>
                            <span class="step-label">Context</span>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="2">
                            <span class="step-dot">2</span>
                            <span class="step-label">Problem</span>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="3">
                            <span class="step-dot">3</span>
                            <span class="step-label">Scope</span>
                        </div>
                    </div>

                    <form id="intakeForm">
                        <!-- Step 1: Context -->
                        <div class="wizard-step active" data-step="1">
                            <h3>Tell us about your organization</h3>
                            <div class="form-group">
                                <label>Organization Name *</label>
                                <input type="text" name="organization" required>
                            </div>
                            <div class="form-group">
                                <label>Your Role *</label>
                                <input type="text" name="role" required>
                            </div>
                            <div class="form-group">
                                <label>Region of Interest *</label>
                                <select name="region" required>
                                    <option value="">Select region...</option>
                                    <option value="prd">Pearl River Delta</option>
                                    <option value="yangtze">Yangtze River Delta</option>
                                    <option value="bohai">Bohai Bay</option>
                                    <option value="seasia">Southeast Asia</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Timeline *</label>
                                <select name="timeline" required>
                                    <option value="">Select timeline...</option>
                                    <option value="urgent">Urgent (< 1 month)</option>
                                    <option value="normal">Normal (1-3 months)</option>
                                    <option value="planning">Planning (3-6 months)</option>
                                    <option value="future">Future (> 6 months)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Step 2: Problem -->
                        <div class="wizard-step" data-step="2">
                            <h3>Describe your challenge</h3>
                            <div class="form-group">
                                <label>Target Waterbody *</label>
                                <input type="text" name="waterbody" placeholder="e.g., Shenzhen Bay">
                            </div>
                            <div class="form-group">
                                <label>Data Availability *</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" name="data_sources" value="monitoring"> Monitoring stations</label>
                                    <label><input type="checkbox" name="data_sources" value="industrial"> Industrial discharge data</label>
                                    <label><input type="checkbox" name="data_sources" value="wwtp"> WWTP records</label>
                                    <label><input type="checkbox" name="data_sources" value="none"> No existing data</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Decision Deadline</label>
                                <input type="date" name="deadline">
                            </div>
                            <div class="form-group">
                                <label>Key Stakeholders</label>
                                <input type="number" name="stakeholder_count" min="1" max="100" placeholder="Number of stakeholders">
                            </div>
                        </div>

                        <!-- Step 3: Scope -->
                        <div class="wizard-step" data-step="3">
                            <h3>Define your scope</h3>
                            <div class="form-group">
                                <label>Preferred Service Tier *</label>
                                <select name="tier" required>
                                    <option value="">Select tier...</option>
                                    <option value="rapid">Rapid Assessment (2 weeks)</option>
                                    <option value="baseline">Baseline MFA (6-8 weeks)</option>
                                    <option value="custom">Custom Program (Quarterly)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Budget Range *</label>
                                <select name="budget" required>
                                    <option value="">Select budget...</option>
                                    <option value="low">< $10k</option>
                                    <option value="medium">$10k - $50k</option>
                                    <option value="high">$50k - $100k</option>
                                    <option value="enterprise">$100k+</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" name="nda" value="yes"> NDA Required</label>
                            </div>
                            <div class="form-group">
                                <label>Additional Comments</label>
                                <textarea name="comments" rows="3"></textarea>
                            </div>
                        </div>
                    </form>

                    <div class="wizard-buttons">
                        <button class="wizard-btn prev" onclick="prevStep()" style="display: none;">Previous</button>
                        <button class="wizard-btn next" onclick="nextStep()">Next</button>
                        <button class="wizard-btn submit" onclick="submitIntake()" style="display: none;">Submit Assessment</button>
                    </div>
                </div>

                <!-- Thank You Message (hidden initially) -->
                <div class="thank-you-message" id="thankYouMessage" style="display: none;">
                    <div class="success-icon">âœ“</div>
                    <h3>Thank You for Your Submission!</h3>
                    <p>Lead Score: <span id="leadScore">0</span>/100</p>
                    <p id="leadMessage"></p>
                    <button class="cta-button" onclick="downloadOnePager()">Download One-Pager</button>
                </div>
            </section>

            <!-- FAQ Section -->
            <section class="faq-section">
                <h2 class="section-title">Frequently Asked Questions</h2>
                <div class="faq-container">
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>What is Material Flow Analysis (MFA)?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            MFA is a systematic assessment of flows and stocks of materials within a defined system. For microplastics, we track sources, pathways, and sinks to quantify pollution loads and identify intervention points.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>How accurate are your assessments?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            Our assessments achieve 85-92% accuracy when validated against field measurements. We use uncertainty quantification and sensitivity analysis to provide confidence intervals for all estimates.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>What data do you need from us?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            Minimum requirements include: watershed boundaries, major discharge points, and basic hydrology. Ideal datasets include industrial permits, WWTP operations, land use, and any existing monitoring data.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Can you work with confidential data?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            Yes, we routinely handle sensitive industrial and governmental data. We offer comprehensive NDAs, secure data handling protocols, and can work with anonymized datasets when required.
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Calendar Modal -->
        <div class="modal" id="calendarModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Schedule Your Scoping Call</h2>
                    <button class="close-btn" onclick="closeCalendarModal()">&times;</button>
                </div>
                <div class="calendar-container">
                    <h3 style="color: var(--teal-primary); margin-bottom: 1rem;">Available Time Slots</h3>
                    <div class="time-slots">
                        <div class="slot-day">
                            <div class="slot-date">Mon, Nov 11</div>
                            <button class="time-slot" onclick="selectTimeSlot(this)">09:00 AM</button>
                            <button class="time-slot" onclick="selectTimeSlot(this)">02:00 PM</button>
                            <button class="time-slot" onclick="selectTimeSlot(this)">04:00 PM</button>
                        </div>
                        <div class="slot-day">
                            <div class="slot-date">Tue, Nov 12</div>
                            <button class="time-slot" onclick="selectTimeSlot(this)">10:00 AM</button>
                            <button class="time-slot" onclick="selectTimeSlot(this)">01:00 PM</button>
                            <button class="time-slot" onclick="selectTimeSlot(this)">03:00 PM</button>
                        </div>
                        <div class="slot-day">
                            <div class="slot-date">Wed, Nov 13</div>
                            <button class="time-slot" onclick="selectTimeSlot(this)">11:00 AM</button>
                            <button class="time-slot" onclick="selectTimeSlot(this)">02:00 PM</button>
                            <button class="time-slot" onclick="selectTimeSlot(this)">05:00 PM</button>
                        </div>
                    </div>
                    <div class="contact-info" style="margin-top: 2rem;">
                        <h4 style="color: var(--teal-light); margin-bottom: 1rem;">Your Contact Information</h4>
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="contactName" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="contactEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="contactPhone">
                        </div>
                        <button class="cta-button" onclick="confirmSchedule()" style="width: 100%; margin-top: 1rem;">Confirm Schedule</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Case Study Modal -->
        <div class="modal" id="caseStudyModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="caseStudyTitle">Case Study Details</h2>
                    <button class="close-btn" onclick="closeCaseStudyModal()">&times;</button>
                </div>
                <div id="caseStudyContent">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Data Packages Section -->
        <div class="data-packages" id="data-packages">
<!-- Data Packages UI -->
<div class="dp-layout">
  <!-- Filters -->
  <aside class="dp-filters dp-sticky metric-card">
    <h3 class="dp-h3">Catalog Filters</h3>
    <div class="filter-block">
      <div class="filter-title">Region</div>
      <div class="chips" id="fRegion"></div>
                        </div>
    <div class="filter-block">
      <div class="filter-title">Product</div>
      <div class="chips" id="fProduct"></div>
                        </div>
    <div class="filter-block">
      <div class="filter-title">Plastics</div>
      <div class="chips" id="fPlastics"></div>
                        </div>
    <div class="filter-block">
      <div class="filter-title">Vintage</div>
      <div class="chips" id="fVintage"></div>
                        </div>
    <div class="filter-block">
      <div class="filter-title">Use Rights</div>
      <div class="chips" id="fRights"></div>
                    </div>
    <div class="dp-sep"></div>
    <button class="btn" onclick="DataPackages.clearFilters()">Reset</button>
  </aside>

  <!-- Catalog + QS + FAQ -->
  <div>
    <div class="dp-toolbar">
      <input class="search" id="pkgSearch" placeholder="Search packages, e.g. 'WWTP points' or 'MFA links'"/>
      <div class="badge" id="resultCount">0 results</div>
                        </div>
    <div class="grid" id="pkgGrid"></div>

    <!-- API Quick-Start -->
    <div class="metric-card" style="margin-top:1rem">
      <details open>
        <summary style="cursor:pointer"><h3 style="display:inline;color:var(--teal-primary)">API Quick-Start</h3></summary>
        <p class="muted" style="margin:.5rem 0 0.5rem;color:var(--text-secondary)">Mock endpoints & sample responses. Rate limit: 60 req/min.</p>
<pre><code>// Get monthly inputs (mock)
GET https://api.oceanpulse.mock/v1/inputs?region=GBA&amp;month=2025-09&amp;plastic=Fibers

// Sample response
{
  "poi_id":"sz_bay","month":"2025-09","plastic":"Fibers",
  "input_tons":312.4,"retention_rate":0.67,"export_tons":104.1
}</code></pre>
<pre><code>// GeoJSON sources (mock)
GET https://api.oceanpulse.mock/v1/sources?region=PRD&amp;type=wwtp

// Sample response (feature)
{ "type":"Feature","geometry":{"type":"Point","coordinates":[113.93,22.50]},
  "properties":{"id":"wwtp-01","name":"Shenzhen WWTP A","flow_m3d":320000} }</code></pre>
      </details>
                </div>

    <!-- FAQ -->
    <div class="metric-card" style="margin-top:1rem">
      <h3 style="color:var(--teal-primary);margin-bottom:.5rem">FAQ & Compliance</h3>
      <details><summary>License & redistribution</summary><p class="muted">Single-site allows internal use at one site; multi-site covers multiple facilities within one legal entity; enterprise permits group-wide usage. Redistribution is restricted to derivative visualizations with attribution.</p></details>
      <details><summary>Attribution</summary><p class="muted">Please cite â€œOceanPulse (Year), Microplastics MFA datasetsâ€ and include link to your license key id.</p></details>
      <details><summary>Academic/Government discounts</summary><p class="muted">Academic 30% off; Government 15% off (applied at quote).</p></details>
                        </div>
                </div>
            </div>


<!-- Pricing Drawer (global) -->
<button class="dp-toggle" id="dpDrawerToggle" onclick="DP_UI.toggleDrawer()">Pricing</button>
<aside class="drawer" id="pricingDrawer" aria-label="Pricing Estimator">
  <h3>Pricing Estimator</h3>
  <div class="filter-block">
    <label class="filter-title">Geography</label>
    <select id="priceRegion" class="select">
      <option value="city">City</option><option value="prd">PRD</option><option value="gba" selected>GBA</option>
                            </select>
                        </div>
  <div class="row">
    <div class="filter-block" style="flex:1">
      <label class="filter-title">License</label>
      <select id="priceLicense" class="select">
        <option value="single">Single-site</option>
        <option value="multi">Multi-site</option>
        <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
    <div class="filter-block" style="flex:1">
      <label class="filter-title">Updates</label>
      <select id="priceUpdate" class="select">
        <option value="oneoff">One-off</option>
        <option value="quarterly">Quarterly</option>
        <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        </div>
  <div class="inline">
    <label><input type="checkbox" id="discAcademic"/> Academic (30%)</label>
    <label><input type="checkbox" id="discGov"/> Government (15%)</label>
                    </div>
  <div class="dp-sep"></div>
  <div id="priceBreak"></div>
  <div class="dp-sep"></div>
  <div class="total" id="priceTotal">$0</div>
  <button class="cta-button" style="width:100%;margin-top:.5rem" onclick="Quote.open()">Request invoice</button>
</aside>

        <!-- Schema Modal -->
        <div class="modal" id="schemaModal">
  <div class="modal-content">
                <div class="modal-header">
      <h2 class="modal-title" id="schemaTitle">Schema</h2>
      <button class="modal-close" onclick="DP_UI.hideModal('schemaModal')">&times;</button>
                </div>
    <div class="modal-body" id="schemaBody"></div>
            </div>
        </div>

        <!-- Quote Cart Modal -->
<div class="modal" id="quoteModal">
  <div class="modal-content">
                <div class="modal-header">
      <h2 class="modal-title">Quote Cart</h2>
      <button class="modal-close" onclick="DP_UI.hideModal('quoteModal')">&times;</button>
                </div>
    <div class="modal-body">
      <div id="cartItems"></div>
      <div class="dp-sep"></div>
      <div class="row">
        <input class="input" id="quoteEmail" placeholder="Work email *"/>
        <input class="input" id="quoteCompany" placeholder="Organization *"/>
                    </div>
      <div class="inline" style="margin:.35rem 0">
        <label><input type="checkbox" id="acceptTou"/> I accept Terms of Use</label>
                        </div>
      <button class="cta-button" onclick="Quote.generate()">Generate quote (HTML)</button>
      <div id="quoteMsg" class="muted" style="margin-top:.5rem"></div>
                        </div>
                        </div>
                    </div>
                </div>
        <!-- Industry Solutions Section -->
        <div class="industry" id="industry">
            <div class="industry-container">
                <!-- Header -->
                <div class="industry-header">
                    <h1 class="section-title">Industry-Specific Solutions</h1>
                    <p class="section-subtitle">Tailored bundles with proven outcomes for your sector</p>
                </div>

                <!-- Segment Selector -->
                <div class="segment-selector">
                    <button class="segment-pill active" data-segment="government" onclick="switchSegment('government')">
                        <span class="segment-icon">ðŸ›ï¸</span>
                        Government & Parks
                    </button>
                    <button class="segment-pill" data-segment="fisheries" onclick="switchSegment('fisheries')">
                        <span class="segment-icon">ðŸŸ</span>
                        Fisheries & Tourism
                    </button>
                    <button class="segment-pill" data-segment="finance" onclick="switchSegment('finance')">
                        <span class="segment-icon">ðŸ’°</span>
                        Finance & Insurance
                    </button>
                </div>

                <!-- Bundle Overview Section -->
                <div class="bundles-section" id="bundlesSection">
                    <!-- Dynamically populated based on selected segment -->
                </div>

                <!-- Outcome Pathways -->
                <div class="outcome-pathways">
                    <h2 class="section-title">Impact Pathway</h2>
                    <div class="pathway-container">
                        <div class="pathway-stage">
                            <div class="pathway-icon">ðŸ“Š</div>
                            <div class="pathway-label">Data Inputs</div>
                            <div class="pathway-desc">Sensors, Models, Reports</div>
                        </div>
                        <div class="pathway-arrow">â†’</div>
                        <div class="pathway-stage">
                            <div class="pathway-icon">ðŸŽ¯</div>
                            <div class="pathway-label">Exposure Analysis</div>
                            <div class="pathway-desc">Risk Scoring, Hotspots</div>
                        </div>
                        <div class="pathway-arrow">â†’</div>
                        <div class="pathway-stage">
                            <div class="pathway-icon">âš ï¸</div>
                            <div class="pathway-label">Impact Assessment</div>
                            <div class="pathway-desc">Economic, Environmental</div>
                        </div>
                        <div class="pathway-arrow">â†’</div>
                        <div class="pathway-stage">
                            <div class="pathway-icon">âœ…</div>
                            <div class="pathway-label">Decisions</div>
                            <div class="pathway-desc">Policy, Operations</div>
                        </div>
                    </div>
                </div>

                <!-- Playbooks Section -->
                <div class="playbooks-section">
                    <h2 class="section-title">Implementation Playbooks</h2>
                    <div class="playbooks-accordion" id="playbooksAccordion">
                        <div class="playbook-item">
                            <div class="playbook-header" onclick="togglePlaybook(this)">
                                <span>ðŸ“‹ Data Collection & Integration</span>
                                <span class="playbook-toggle">+</span>
                            </div>
                            <div class="playbook-content">
                                <h4>Required Data</h4>
                                <ul>
                                    <li>Watershed boundaries and discharge points</li>
                                    <li>Industrial permits and WWTP operations</li>
                                    <li>Monitoring station data (if available)</li>
                                    <li>Land use and population density</li>
                                </ul>
                                <h4>Workflow Steps</h4>
                                <ol>
                                    <li>Initial data audit and gap analysis</li>
                                    <li>Deploy monitoring infrastructure</li>
                                    <li>Integrate existing data sources</li>
                                    <li>Validate with field sampling</li>
                                    <li>Establish QA/QC procedures</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="playbook-item">
                            <div class="playbook-header" onclick="togglePlaybook(this)">
                                <span>ðŸ”„ Operational Workflow</span>
                                <span class="playbook-toggle">+</span>
                            </div>
                            <div class="playbook-content">
                                <h4>Decision Hooks</h4>
                                <ul>
                                    <li>Threshold alerts for regulatory compliance</li>
                                    <li>Seasonal closure recommendations</li>
                                    <li>Investment risk assessments</li>
                                    <li>Emergency response triggers</li>
                                </ul>
                                <h4>Reporting Templates</h4>
                                <ul>
                                    <li>Monthly compliance dashboard</li>
                                    <li>Quarterly stakeholder briefing</li>
                                    <li>Annual environmental report</li>
                                    <li>Incident response documentation</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="playbook-item">
                            <div class="playbook-header" onclick="togglePlaybook(this)">
                                <span>ðŸ“ˆ Performance Monitoring</span>
                                <span class="playbook-toggle">+</span>
                            </div>
                            <div class="playbook-content">
                                <h4>Key Metrics</h4>
                                <ul>
                                    <li>Plastic input reduction rate</li>
                                    <li>Compliance percentage</li>
                                    <li>Response time to incidents</li>
                                    <li>Cost savings from prevention</li>
                                </ul>
                                <h4>Optimization Strategies</h4>
                                <ul>
                                    <li>Continuous model calibration</li>
                                    <li>Stakeholder feedback integration</li>
                                    <li>Seasonal adjustment protocols</li>
                                    <li>Technology stack updates</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROI Calculator -->
                <div class="roi-section">
                    <h2 class="section-title">ROI Calculator</h2>
                    <div class="roi-container">
                        <div class="roi-inputs">
                            <h3>Your Parameters</h3>
                            <div class="roi-form">
                                <div class="form-group">
                                    <label>Affected Coastline (km)</label>
                                    <input type="number" id="coastlineKm" value="50" min="1" onchange="calculateROI()">
                                </div>
                                <div class="form-group">
                                    <label>Incidents per Year</label>
                                    <input type="number" id="incidentsYear" value="12" min="0" onchange="calculateROI()">
                                </div>
                                <div class="form-group">
                                    <label>Cleanup Cost per Event ($)</label>
                                    <input type="number" id="cleanupCost" value="25000" min="0" onchange="calculateROI()">
                                </div>
                                <div class="form-group">
                                    <label>Value at Risk ($M)</label>
                                    <input type="number" id="valueAtRisk" value="10" min="0" step="0.1" onchange="calculateROI()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="roi-outputs">
                            <h3>Expected Returns</h3>
                            <div class="roi-metrics">
                                <div class="roi-metric">
                                    <div class="roi-value" id="avoidedCost">$150,000</div>
                                    <div class="roi-label">Annual Avoided Cost</div>
                                </div>
                                <div class="roi-metric">
                                    <div class="roi-value" id="paybackMonths">8</div>
                                    <div class="roi-label">Payback (months)</div>
                                </div>
                                <div class="roi-metric">
                                    <div class="roi-value" id="npvValue">$420,000</div>
                                    <div class="roi-label">3-Year NPV (8%)</div>
                                </div>
                                <div class="roi-metric">
                                    <div class="roi-value" id="roiPercent">215%</div>
                                    <div class="roi-label">ROI</div>
                                </div>
                            </div>
                            <canvas id="roiChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- RFQ Section -->
                <div class="rfq-section">
                    <h2 class="section-title">Request for Quote</h2>
                    <div class="rfq-wizard">
                        <div class="rfq-step active" data-step="1">
                            <h3>1. Select Your Bundle</h3>
                            <div class="bundle-selector" id="bundleSelector">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                        
                        <div class="rfq-step" data-step="2">
                            <h3>2. Add-On Services</h3>
                            <div class="addon-grid" id="addonGrid">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                        
                        <div class="rfq-step" data-step="3">
                            <h3>3. Deployment Scope</h3>
                            <div class="deployment-options">
                                <div class="form-group">
                                    <label>Implementation Timeline</label>
                                    <select id="rfqTimeline">
                                        <option value="rapid">Rapid (2-4 weeks)</option>
                                        <option value="standard">Standard (6-8 weeks)</option>
                                        <option value="phased">Phased (3-6 months)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Geographic Coverage</label>
                                    <select id="rfqCoverage">
                                        <option value="single">Single Bay/Port</option>
                                        <option value="regional">Regional (Multiple Sites)</option>
                                        <option value="national">National</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Support Level</label>
                                    <select id="rfqSupport">
                                        <option value="basic">Basic (Email)</option>
                                        <option value="standard">Standard (Business Hours)</option>
                                        <option value="premium">Premium (24/7 + Dedicated)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rfq-step" data-step="4">
                            <h3>4. Contact Information</h3>
                            <div class="contact-form">
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="rfqName" required>
                                </div>
                                <div class="form-group">
                                    <label>Organization *</label>
                                    <input type="text" id="rfqOrg" required>
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="rfqEmail" required>
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="rfqPhone">
                                </div>
                                <div class="form-group">
                                    <label>Additional Requirements</label>
                                    <textarea id="rfqNotes" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rfq-navigation">
                            <button class="rfq-btn prev" onclick="prevRFQStep()" style="display: none;">Previous</button>
                            <button class="rfq-btn next" onclick="nextRFQStep()">Next</button>
                            <button class="rfq-btn submit" onclick="generateRFQ()" style="display: none;">Generate RFQ</button>
                        </div>
                        
                        <div class="rfq-summary" id="rfqSummary">
                            <h3>Quote Summary</h3>
                            <div id="rfqSummaryContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Case Examples -->
                <div class="case-examples">
                    <h2 class="section-title">Success Stories by Sector</h2>
                    <div class="examples-grid" id="examplesGrid">
                        <!-- Dynamically populated based on segment -->
                    </div>
                </div>
            </div>
        </div>

        <!-- About Us Section -->
        <div class="about" id="about">
            <div class="about-container">
                <div class="about-header">
                    <h1 class="about-title">Our Team</h1>
                    <p class="about-subtitle">
                        OceanPulse is a joint initiative bridging environmental systems science, ocean modeling,
                        and stakeholder engagement across Switzerland and China. Our founding team combines
                        life-cycle expertise, numerical modeling, and data partnerships to help cities and coastlines
                        accelerate plastic recovery.
                    </p>
                </div>

                <div class="about-logos">
                    <div class="about-logo">ETH ZÃ¼rich</div>
                    <div class="about-logo">Empa</div>
                    <div class="about-logo">Tsinghua University</div>
                    <div class="about-logo">OceanPulse</div>
                </div>

                <div class="team-grid">
                    <div class="team-card">
                        <div class="team-photo" data-initials="ZL"></div>
                        <div class="team-name">Zipeng Liu</div>
                        <div class="team-name-cn">åˆ˜å­é¹</div>
                        <div class="team-role">Plastic life-cycle modeling</div>
                        <div class="team-role-cn">å¡‘æ–™ç”Ÿå‘½å‘¨æœŸæ¨¡åž‹</div>
                        <div class="team-affiliation">
                            Department of Environmental Systems Science, ETH ZÃ¼rich
                        </div>
                        <div class="team-affiliation-cn">è‹é»Žä¸–è”é‚¦ç†å·¥å¤§å­¦ çŽ¯å¢ƒç³»ç»Ÿç§‘å­¦ç³»</div>
                    </div>

                    <div class="team-card">
                        <div class="team-photo" data-initials="YD"></div>
                        <div class="team-name">Yucan Dong</div>
                        <div class="team-name-cn">è‘£æ˜±ç’¨</div>
                        <div class="team-role">Ocean modeling &amp; software</div>
                        <div class="team-role-cn">æµ·æ´‹æ¨¡åž‹å’Œè½¯ä»¶</div>
                        <div class="team-affiliation">
                            Department of Environmental Systems Science, ETH ZÃ¼rich
                        </div>
                        <div class="team-affiliation-cn">è‹é»Žä¸–è”é‚¦ç†å·¥å¤§å­¦ çŽ¯å¢ƒç³»ç»Ÿç§‘å­¦ç³»</div>
                    </div>

                    <div class="team-card">
                        <div class="team-photo" data-initials="BZ"></div>
                        <div class="team-name">Bingqian Zhang</div>
                        <div class="team-name-cn">å¼ å†°å€©</div>
                        <div class="team-role">Data management &amp; stakeholder engagement</div>
                        <div class="team-role-cn">æ•°æ®ç®¡ç†å’Œå¤šåˆ©ç›Šç›¸å…³è€…åˆ†æž</div>
                        <div class="team-affiliation">
                            School of Environment, Tsinghua University
                        </div>
                        <div class="team-affiliation-cn">æ¸…åŽå¤§å­¦ çŽ¯å¢ƒå­¦é™¢</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Telemetry Modal (Mock Admin) -->
        <div class="modal" id="telemetryModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">ðŸ“Š Analytics Dashboard (Dev)</h2>
                    <button class="close-btn" onclick="closeTelemetryModal()">&times;</button>
                </div>
                <div class="telemetry-content">
                    <h3>Click Tracking</h3>
                    <div id="telemetryStats"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MFA Modal -->
    <div class="modal" id="mfaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Material Flow Analysis</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container sankey-container">
                    <div id="sankeyChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="chart-container">
                    <div id="monthlyInputChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="chart-container">
                    <div id="riskAssessmentChart" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
            
            <div class="metrics-row" style="margin-top: 1rem;">
                <div class="metric-card">
                    <div class="metric-value">1,480</div>
                    <div class="metric-label">Total Input (tons)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">67%</div>
                    <div class="metric-label">Retention %</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">488</div>
                    <div class="metric-label">Export (tons)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">Packaging</div>
                    <div class="metric-label">Top Source</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">PE</div>
                    <div class="metric-label">Top Plastic</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Drawer -->
    <div class="right-drawer" id="rightDrawer">
        <button class="drawer-toggle" onclick="toggleDrawer()">Filters</button>
        <h3 style="color: var(--teal-primary); margin-bottom: 1rem;">Active Filters</h3>
        <div id="activeFilters"></div>
        
        <h3 style="color: var(--teal-primary); margin: 2rem 0 1rem;">Export Options</h3>
        <button class="scenario-btn" style="width: 100%; margin-bottom: 0.5rem;" onclick="downloadCSV()">
            ðŸ“¥ Download Data (CSV)
        </button>
        <button class="scenario-btn" style="width: 100%;" onclick="exportChart()">
            ðŸ“¸ Export Chart (PNG)
        </button>
    </div>

    <script>
        // ========== Data Store Module ==========
        const DataStore = {
            // Mock POIs data
            pois: [
                { id: "sz_bay", name: "Shenzhen Bay", coords: [113.93, 22.50], type: "bay" },
                { id: "deep_bay", name: "Deep Bay", coords: [113.91, 22.48], type: "bay" },
                { id: "hk_waters", name: "Hong Kong Waters", coords: [114.15, 22.28], type: "waters" },
                { id: "gz_estuary", name: "Guangzhou Estuary", coords: [113.50, 22.80], type: "estuary" },
                { id: "zhuhai", name: "Zhuhai Coastal", coords: [113.57, 22.27], type: "coastal" },
                { id: "macao", name: "Macao Waters", coords: [113.55, 22.20], type: "waters" },
                { id: "dongguan", name: "Dongguan River", coords: [113.75, 23.02], type: "river" },
                { id: "foshan", name: "Foshan Industrial", coords: [113.12, 23.02], type: "industrial" },
                { id: "zhongshan", name: "Zhongshan Port", coords: [113.38, 22.52], type: "port" },
                { id: "huizhou", name: "Huizhou Bay", coords: [114.40, 22.80], type: "bay" },
                { id: "jiangmen", name: "Jiangmen Estuary", coords: [113.08, 22.58], type: "estuary" },
                { id: "nansha", name: "Nansha Port", coords: [113.60, 22.70], type: "port" },
                { id: "shekou", name: "Shekou Terminal", coords: [113.91, 22.47], type: "terminal" },
                { id: "yantian", name: "Yantian Port", coords: [114.27, 22.58], type: "port" },
                { id: "daya_bay", name: "Daya Bay", coords: [114.53, 22.63], type: "bay" },
                { id: "lingding", name: "Lingdingyang", coords: [113.80, 22.40], type: "waters" },
                { id: "humen", name: "Humen Bridge", coords: [113.61, 22.79], type: "bridge" },
                { id: "qianhai", name: "Qianhai Zone", coords: [113.90, 22.54], type: "development" },
                { id: "hengqin", name: "Hengqin Island", coords: [113.52, 22.13], type: "island" },
                { id: "lantau", name: "Lantau Waters", coords: [113.95, 22.27], type: "waters" },
                { id: "tuen_mun", name: "Tuen Mun", coords: [113.97, 22.39], type: "urban" },
                { id: "pearl_mouth", name: "Pearl River Mouth", coords: [113.70, 22.50], type: "mouth" },
                { id: "dongjiang", name: "Dongjiang Delta", coords: [114.00, 23.00], type: "delta" },
                { id: "xijiang", name: "Xijiang Flow", coords: [113.20, 22.70], type: "river" },
                { id: "beijiang", name: "Beijiang Junction", coords: [113.40, 23.10], type: "junction" }
            ],

            // Mock time series data generator
            generateTimeSeries(poiId, months = 36) {
                const data = [];
                const baseInput = 100 + Math.random() * 500;
                const seasonalPattern = [1.2, 1.1, 1.0, 0.9, 0.8, 0.85, 0.9, 1.0, 1.1, 1.2, 1.3, 1.25];
                
                for (let i = 0; i < months; i++) {
                    const month = new Date(2023, i, 1);
                    const seasonalFactor = seasonalPattern[i % 12];
                    const noise = 0.8 + Math.random() * 0.4;
                    
                    data.push({
                        poi_id: poiId,
                        month: month.toISOString().slice(0, 7),
                        plastic: "Mixed",
                        input_tons: baseInput * seasonalFactor * noise,
                        retention_rate: 0.5 + Math.random() * 0.3,
                        export_tons: baseInput * seasonalFactor * noise * (0.3 + Math.random() * 0.2),
                        risk_index: 40 + Math.random() * 40
                    });
                }
                
                return data;
            },

            // Mock MFA Sankey data
            generateMFAData(poiId, month, plasticFilter = ["PE", "Fibers"]) {
                return {
                    poi_id: poiId,
                    month: month,
                    plastic_filter: plasticFilter,
                    nodes: [
                        "Packaging", "Textiles", "Industrial", "Fisheries",
                        "River System", "WWTP", "Direct Discharge",
                        "Bay Input", "Retention", "Export to Ocean"
                    ],
                    links: [
                        { source: "Packaging", target: "River System", value: 820 },
                        { source: "Textiles", target: "WWTP", value: 460 },
                        { source: "Industrial", target: "Direct Discharge", value: 210 },
                        { source: "Fisheries", target: "Direct Discharge", value: 180 },
                        { source: "River System", target: "Bay Input", value: 780 },
                        { source: "WWTP", target: "Bay Input", value: 320 },
                        { source: "Direct Discharge", target: "Bay Input", value: 380 },
                        { source: "Bay Input", target: "Retention", value: 980 },
                        { source: "Bay Input", target: "Export to Ocean", value: 500 }
                    ],
                    units: "tons/month"
                };
            },

            // Mock regulatory zones
            getRegulatoryZones() {
                return {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: [[[113.88, 22.45], [113.98, 22.45], [113.98, 22.55], [113.88, 22.55], [113.88, 22.45]]]
                            },
                            properties: {
                                id: "reg-001",
                                name: "Shenzhen Bay Ecological Redline",
                                category: "redline",
                                reg_text: "No discharge above Class IV; microplastic limit 0.1 g/mÂ³",
                                compliance_score: 72
                            }
                        },
                        {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: [[[114.10, 22.25], [114.20, 22.25], [114.20, 22.35], [114.10, 22.35], [114.10, 22.25]]]
                            },
                            properties: {
                                id: "reg-002",
                                name: "Hong Kong Marine Reserve",
                                category: "MPA",
                                reg_text: "Protected area - fishing restrictions apply",
                                compliance_score: 85
                            }
                        }
                    ]
                };
            },

            // Mock WWTP data
            getWWTPData() {
                return {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.93, 22.50] },
                            properties: {
                                id: "wwtp-01",
                                name: "Shenzhen WWTP A",
                                type: "WWTP",
                                flow_m3d: 320000,
                                mp_removal_eff: 0.86
                            }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [114.15, 22.30] },
                            properties: {
                                id: "wwtp-02",
                                name: "Hong Kong Central",
                                type: "WWTP",
                                flow_m3d: 450000,
                                mp_removal_eff: 0.92
                            }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.50, 22.85] },
                            properties: {
                                id: "wwtp-03",
                                name: "Guangzhou South",
                                type: "WWTP",
                                flow_m3d: 280000,
                                mp_removal_eff: 0.78
                            }
                        }
                    ]
                };
            },

            // Returns monthly inputs honoring current filters
            getMonthlyInputs({ poiId = 'all', months = 36, plastics = [], sources = [] } = {}) {
                const base = this.generateTimeSeries(poiId, months);
                
                // Use all types if none selected (no filter = show all)
                const allPlastics = ['PE', 'PP', 'PET', 'PS', 'PVC', 'Fibers', 'TireWear', 'Mixed'];
                const allSources = ['Packaging', 'Textiles', 'Industrial', 'Fisheries', 'UrbanRunoff', 'Maritime'];
                
                const activePlastics = plastics.length > 0 ? plastics : allPlastics;
                const activeSources = sources.length > 0 ? sources : allSources;
                
                // Calculate filter factors (proportion of active types)
                const plasticFactor = activePlastics.length / allPlastics.length;
                const sourceFactor = activeSources.length / allSources.length;
                
                // Apply filters with deterministic variation
                return base.map((d, i) => {
                    // Add some variation based on filter selection
                    const plasticVariation = activePlastics.includes('Fibers') ? 1.1 : 1.0;
                    const sourceVariation = activeSources.includes('Industrial') ? 1.15 : 1.0;
                    
                    const adjustedInput = d.input_tons * plasticFactor * sourceFactor * 
                                          plasticVariation * sourceVariation;
                    
                    return {
                        month: d.month,
                        macro: adjustedInput * 0.6 * (1 + Math.sin(i * 0.2) * 0.1),
                        micro: adjustedInput * 0.4 * (1 + Math.cos(i * 0.2) * 0.1)
                    };
                });
            },

            // Mock data for additional layers
            getFisheriesData() {
                return {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: [[[113.7, 22.3], [113.8, 22.3], [113.8, 22.4], [113.7, 22.4], [113.7, 22.3]]]
                            },
                            properties: { id: "fish-01", name: "Coastal Fishing Zone A", type: "fishing_ground" }
                        },
                        {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: [[[114.0, 22.2], [114.1, 22.2], [114.1, 22.3], [114.0, 22.3], [114.0, 22.2]]]
                            },
                            properties: { id: "fish-02", name: "Aquaculture Area B", type: "aquaculture" }
                        }
                    ]
                };
            },

            getIndustrialData() {
                return {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.75, 22.65] },
                            properties: { id: "ind-01", name: "Dongguan Industrial Park", emissions: "high" }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.55, 22.45] },
                            properties: { id: "ind-02", name: "Nansha Chemical Zone", emissions: "medium" }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [114.05, 22.55] },
                            properties: { id: "ind-03", name: "Shenzhen Tech Park", emissions: "low" }
                        }
                    ]
                };
            },

            getTourismData() {
                return {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.98, 22.24] },
                            properties: { id: "tour-01", name: "Repulse Bay Beach", visitors: 50000 }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.85, 22.28] },
                            properties: { id: "tour-02", name: "Discovery Bay", visitors: 30000 }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [114.20, 22.30] },
                            properties: { id: "tour-03", name: "Sai Kung Beaches", visitors: 25000 }
                        }
                    ]
                };
            },

            getMonitoringData() {
                return {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.90, 22.45] },
                            properties: { id: "mon-01", name: "Station Alpha", type: "fixed", status: "active" }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [114.10, 22.35] },
                            properties: { id: "mon-02", name: "Station Beta", type: "buoy", status: "active" }
                        },
                        {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [113.70, 22.50] },
                            properties: { id: "mon-03", name: "Station Gamma", type: "fixed", status: "maintenance" }
                        }
                    ]
                };
            },

            getHeatmapData() {
                // Generate grid points for heatmap
                const points = [];
                for (let lng = 113.5; lng <= 114.3; lng += 0.1) {
                    for (let lat = 22.1; lat <= 22.6; lat += 0.1) {
                        points.push({
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [lng, lat] },
                            properties: {
                                concentration: Math.random() * 5 + Math.sin((lng + lat) * 10) * 2
                            }
                        });
                    }
                }
                return { type: "FeatureCollection", features: points };
            },

            getCurrentsData() {
                // Generate simple current vectors
                return {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry: {
                                type: "LineString",
                                coordinates: [[113.5, 22.3], [113.6, 22.35], [113.7, 22.4]]
                            },
                            properties: { id: "curr-01", speed: 2.5, direction: "NE" }
                        },
                        {
                            type: "Feature",
                            geometry: {
                                type: "LineString",
                                coordinates: [[114.0, 22.2], [114.05, 22.25], [114.1, 22.3]]
                            },
                            properties: { id: "curr-02", speed: 1.8, direction: "N" }
                        }
                    ]
                };
            }
        };

        // ========== Map Controller Module ==========
        const MapController = {
            map: null,
            activeFilters: {
                plastic: [],
                source: []
            },
            currentMonth: 35,
            scenario: 'baseline',

            initialize() {
                // Initialize MapLibre GL map
                this.map = new maplibregl.Map({
                    container: 'map',
                    style: {
                        version: 8,
                        sources: {
                            'osm': {
                                type: 'raster',
                                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                                tileSize: 256,
                                attribution: 'Â© OpenStreetMap contributors'
                            }
                        },
                        layers: [
                            {
                                id: 'osm',
                                type: 'raster',
                                source: 'osm',
                                paint: {
                                    'raster-brightness-min': 0.2,
                                    'raster-brightness-max': 0.4,
                                    'raster-saturation': -0.5,
                                    'raster-hue-rotate': 180
                                }
                            }
                        ]
                    },
                    center: [113.80, 22.50],
                    zoom: 9,
                    attributionControl: false
                });

                // Add navigation controls
                this.map.addControl(new maplibregl.NavigationControl(), 'top-left');
                this.map.addControl(new maplibregl.ScaleControl(), 'bottom-left');
                this.map.addControl(new maplibregl.FullscreenControl(), 'top-left');

                // Wait for map to load
                this.map.on('load', () => {
                    this.addDataLayers();
                    this.setupInteractions();
                });
            },

            addDataLayers() {
                // Add POIs as markers
                DataStore.pois.forEach(poi => {
                    const marker = new maplibregl.Marker({
                        color: '#4FD1C5'
                    })
                        .setLngLat(poi.coords)
                        .setPopup(this.createPopup(poi))
                        .addTo(this.map);

                    marker.getElement().addEventListener('click', () => {
                        this.showMFAModal(poi);
                    });
                });

                // Add regulatory zones
                this.map.addSource('regulatory', {
                    type: 'geojson',
                    data: DataStore.getRegulatoryZones()
                });

                this.map.addLayer({
                    id: 'regulatory-layer',
                    type: 'fill',
                    source: 'regulatory',
                    paint: {
                        'fill-color': ['case',
                            ['==', ['get', 'category'], 'redline'], 'rgba(255, 0, 0, 0.3)',
                            ['==', ['get', 'category'], 'MPA'], 'rgba(0, 255, 0, 0.2)',
                            'rgba(255, 255, 0, 0.2)'
                        ],
                        'fill-opacity': 0.5
                    }
                });

                this.map.addLayer({
                    id: 'regulatory-outline',
                    type: 'line',
                    source: 'regulatory',
                    paint: {
                        'line-color': ['case',
                            ['==', ['get', 'category'], 'redline'], '#ff0000',
                            ['==', ['get', 'category'], 'MPA'], '#00ff00',
                            '#ffff00'
                        ],
                        'line-width': 2,
                        'line-dasharray': [2, 2]
                    }
                });

                // Add WWTP points
                this.map.addSource('wwtp', {
                    type: 'geojson',
                    data: DataStore.getWWTPData()
                });

                this.map.addLayer({
                    id: 'wwtp-layer',
                    type: 'circle',
                    source: 'wwtp',
                    paint: {
                        'circle-radius': ['interpolate', ['linear'], ['get', 'flow_m3d'],
                            100000, 8,
                            500000, 20
                        ],
                        'circle-color': 'rgba(0, 100, 255, 0.6)',
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 2
                    }
                });

                // Add Fisheries layer
                this.map.addSource('fisheries', {
                    type: 'geojson',
                    data: DataStore.getFisheriesData()
                });

                this.map.addLayer({
                    id: 'fisheries-layer',
                    type: 'fill',
                    source: 'fisheries',
                    paint: {
                        'fill-color': 'rgba(0, 255, 0, 0.2)',
                        'fill-opacity': 0.4
                    },
                    layout: {
                        'visibility': 'none' // Start hidden
                    }
                });

                // Add Industrial layer
                this.map.addSource('industrial', {
                    type: 'geojson',
                    data: DataStore.getIndustrialData()
                });

                this.map.addLayer({
                    id: 'industrial-layer',
                    type: 'circle',
                    source: 'industrial',
                    paint: {
                        'circle-radius': 12,
                        'circle-color': ['case',
                            ['==', ['get', 'emissions'], 'high'], '#ff6b6b',
                            ['==', ['get', 'emissions'], 'medium'], '#ffa500',
                            '#ffeb3b'
                        ],
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 2,
                        'circle-opacity': 0.8
                    },
                    layout: {
                        'visibility': 'none' // Start hidden
                    }
                });

                // Add Tourism layer
                this.map.addSource('tourism', {
                    type: 'geojson',
                    data: DataStore.getTourismData()
                });

                this.map.addLayer({
                    id: 'tourism-layer',
                    type: 'symbol',
                    source: 'tourism',
                    layout: {
                        'icon-image': 'marker-15',
                        'icon-size': 1.5,
                        'text-field': ['get', 'name'],
                        'text-font': ['Open Sans Regular'],
                        'text-size': 10,
                        'text-offset': [0, 1.5],
                        'visibility': 'none' // Start hidden
                    },
                    paint: {
                        'text-color': '#4FD1C5',
                        'text-halo-color': '#0a0e27',
                        'text-halo-width': 1
                    }
                });

                // Add Monitoring Stations layer
                this.map.addSource('monitoring', {
                    type: 'geojson',
                    data: DataStore.getMonitoringData()
                });

                this.map.addLayer({
                    id: 'monitoring-layer',
                    type: 'circle',
                    source: 'monitoring',
                    paint: {
                        'circle-radius': 10,
                        'circle-color': ['case',
                            ['==', ['get', 'status'], 'active'], '#4FD1C5',
                            '#ffd93d'
                        ],
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 2,
                        'circle-opacity': 0.9
                    },
                    layout: {
                        'visibility': 'none' // Start hidden
                    }
                });

                // Add Heatmap layer for concentration
                this.map.addSource('heatmap', {
                    type: 'geojson',
                    data: DataStore.getHeatmapData()
                });

                this.map.addLayer({
                    id: 'heatmap-layer',
                    type: 'heatmap',
                    source: 'heatmap',
                    paint: {
                        'heatmap-weight': ['get', 'concentration'],
                        'heatmap-intensity': 0.5,
                        'heatmap-radius': 30,
                        'heatmap-opacity': 0.6,
                        'heatmap-color': [
                            'interpolate',
                            ['linear'],
                            ['heatmap-density'],
                            0, 'rgba(0,0,0,0)',
                            0.2, 'rgba(79,209,197,0.4)',
                            0.4, 'rgba(129,230,217,0.6)',
                            0.6, 'rgba(255,217,61,0.8)',
                            0.8, 'rgba(255,107,107,0.9)',
                            1, 'rgba(255,0,0,1)'
                        ]
                    },
                    layout: {
                        'visibility': 'none' // Start hidden
                    }
                });

                // Add Currents layer
                this.map.addSource('currents', {
                    type: 'geojson',
                    data: DataStore.getCurrentsData()
                });

                this.map.addLayer({
                    id: 'currents-layer',
                    type: 'line',
                    source: 'currents',
                    paint: {
                        'line-color': '#81E6D9',
                        'line-width': 3,
                        'line-opacity': 0.6,
                        'line-dasharray': [2, 4]
                    },
                    layout: {
                        'visibility': 'none' // Start hidden
                    }
                });

                // Add shipping lanes (existing code)
                this.addShippingLanes();
                
                // Initialize legend state
                Legend.initialize();
                Legend.update(this.getVisibleLayers());
            },

            addShippingLanes() {
                const shippingRoute = {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: [
                            [113.50, 22.20],
                            [113.60, 22.30],
                            [113.80, 22.40],
                            [114.00, 22.45],
                            [114.20, 22.50]
                        ]
                    }
                };

                this.map.addSource('shipping', {
                    type: 'geojson',
                    data: shippingRoute
                });

                this.map.addLayer({
                    id: 'shipping-layer',
                    type: 'line',
                    source: 'shipping',
                    paint: {
                        'line-color': '#4FD1C5',
                        'line-width': 3,
                        'line-dasharray': [0.5, 2]
                    }
                });

                // Animate shipping lane
                let step = 0;
                const animateDashArray = () => {
                    step = (step + 1) % 8;
                    this.map.setPaintProperty('shipping-layer', 'line-dasharray', [step, 8 - step]);
                    requestAnimationFrame(animateDashArray);
                };
                animateDashArray();
            },

            createPopup(poi) {
                const popupContent = `
                    <div class="popup-title">${poi.name}</div>
                    <div class="popup-content">
                        <p>Type: ${poi.type}</p>
                        <p>Latest Input: ${(100 + Math.random() * 200).toFixed(0)} tons/month</p>
                        <p>Risk Index: ${(40 + Math.random() * 40).toFixed(0)}</p>
                        <div class="popup-chart" id="popup-chart-${poi.id}"></div>
                    </div>
                `;
                
                const popup = new maplibregl.Popup({ offset: 25 })
                    .setHTML(popupContent);
                
                // Add mini chart after popup opens
                popup.on('open', () => {
                    setTimeout(() => {
                        this.createMiniChart(`popup-chart-${poi.id}`, poi.id);
                    }, 100);
                });
                
                return popup;
            },

            createMiniChart(elementId, poiId) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const chart = echarts.init(element);
                const data = DataStore.generateTimeSeries(poiId, 12);
                
                const option = {
                    grid: { top: 5, right: 5, bottom: 20, left: 35 },
                    xAxis: {
                        type: 'category',
                        data: data.map(d => d.month.slice(5)),
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0', fontSize: 9 }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0', fontSize: 9 },
                        splitLine: { show: false }
                    },
                    series: [{
                        type: 'line',
                        data: data.map(d => d.input_tons.toFixed(0)),
                        itemStyle: { color: '#4FD1C5' },
                        areaStyle: { color: 'rgba(79, 209, 197, 0.2)' },
                        smooth: true
                    }]
                };
                
                chart.setOption(option);
            },

            setupInteractions() {
                // Layer toggles - sync checkbox state with actual visibility
                document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
                    // Set initial state based on actual layer visibility
                    const layerId = checkbox.id.replace('layer-', '');
                    const layerMappings = {
                        'regulatory': 'regulatory-layer',
                        'wwtp': 'wwtp-layer',
                        'fisheries': 'fisheries-layer',
                        'industrial': 'industrial-layer',
                        'tourism': 'tourism-layer',
                        'monitoring': 'monitoring-layer',
                        'heatmap': 'heatmap-layer',
                        'currents': 'currents-layer',
                        'shipping': 'shipping-layer'
                    };
                    
                    const mainLayer = layerMappings[layerId];
                    if (mainLayer && this.map.getLayer(mainLayer)) {
                        const visibility = this.map.getLayoutProperty(mainLayer, 'visibility');
                        checkbox.checked = visibility !== 'none';
                    }
                    
                    // Add change listener
                    checkbox.addEventListener('change', (e) => {
                        this.toggleLayer(layerId, e.target.checked);
                    });
                });

                // Click interactions for regulatory zones
                this.map.on('click', 'regulatory-layer', (e) => {
                    const properties = e.features[0].properties;
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <div class="popup-title">${properties.name}</div>
                            <div class="popup-content">
                                <p>Category: ${properties.category}</p>
                                <p>Regulations: ${properties.reg_text}</p>
                                <p>Compliance Score: ${properties.compliance_score}%</p>
                            </div>
                        `)
                        .addTo(this.map);
                });

                // Hover effects
                this.map.on('mouseenter', 'regulatory-layer', () => {
                    this.map.getCanvas().style.cursor = 'pointer';
                });
                
                this.map.on('mouseleave', 'regulatory-layer', () => {
                    this.map.getCanvas().style.cursor = '';
                });
                
                // Similar interactions for other layers
                ['industrial-layer', 'monitoring-layer', 'wwtp-layer'].forEach(layer => {
                    this.map.on('mouseenter', layer, () => {
                        this.map.getCanvas().style.cursor = 'pointer';
                    });
                    
                    this.map.on('mouseleave', layer, () => {
                        this.map.getCanvas().style.cursor = '';
                    });
                });
            },

            toggleLayer(layerId, visible) {
                // Expanded layer mappings for all toggles
                const layerMappings = {
                    'regulatory': ['regulatory-layer', 'regulatory-outline'],
                    'wwtp': ['wwtp-layer'],
                    'fisheries': ['fisheries-layer'],
                    'industrial': ['industrial-layer'],
                    'tourism': ['tourism-layer'],
                    'monitoring': ['monitoring-layer'],
                    'heatmap': ['heatmap-layer'],
                    'currents': ['currents-layer'],
                    'shipping': ['shipping-layer']
                };
                
                const layers = layerMappings[layerId] || [];
                layers.forEach(layer => {
                    if (this.map.getLayer(layer)) {
                        this.map.setLayoutProperty(layer, 'visibility', visible ? 'visible' : 'none');
                    }
                });
                
                // Update legend after toggle
                Legend.update(this.getVisibleLayers());
            },

            getVisibleLayers() {
                const visibleLayers = new Set();
                const checkLayers = [
                    'regulatory-layer', 'wwtp-layer', 'fisheries-layer',
                    'industrial-layer', 'tourism-layer', 'monitoring-layer',
                    'heatmap-layer', 'currents-layer', 'shipping-layer'
                ];
                
                checkLayers.forEach(layerId => {
                    if (this.map.getLayer(layerId)) {
                        const visibility = this.map.getLayoutProperty(layerId, 'visibility');
                        if (visibility !== 'none') {
                            // Map layer ID to checkbox ID format
                            const checkboxId = layerId.replace('-layer', '').replace('-outline', '');
                            visibleLayers.add(checkboxId);
                        }
                    }
                });
                
                return visibleLayers;
            },

            showMFAModal(poi) {
                document.getElementById('modalTitle').textContent = `${poi.name} - Material Flow Analysis`;
                document.getElementById('mfaModal').classList.add('active');
                
                // Initialize charts in modal
                setTimeout(() => {
                    Charts.createSankeyChart(poi.id);
                    Charts.createMonthlyInputChart(poi.id);
                    Charts.createRiskAssessmentChart(poi.id);
                }, 100);
            },

            flyToPOI(poiId) {
                const poi = DataStore.pois.find(p => p.id === poiId);
                if (poi) {
                    this.map.flyTo({
                        center: poi.coords,
                        zoom: 11,
                        duration: 1500
                    });
                }
            }
        };

        // ========== Charts Module ==========
        const Charts = {
            inputChart: null,
            riskChart: null,

            createSankeyChart(poiId) {
                const container = document.getElementById('sankeyChart');
                const chart = echarts.init(container);
                const data = DataStore.generateMFAData(poiId, '2025-10', MapController.activeFilters.plastic);
                
                const option = {
                    title: {
                        text: 'Material Flow: Sources to Ocean',
                        textStyle: { color: '#4FD1C5' }
                    },
                    tooltip: { trigger: 'item' },
                    series: [{
                        type: 'sankey',
                        layout: 'none',
                        emphasis: { focus: 'adjacency' },
                        data: data.nodes.map(name => ({
                            name,
                            itemStyle: { color: this.getNodeColor(name) }
                        })),
                        links: data.links.map(link => ({
                            ...link,
                            value: link.value * (MapController.scenario === 'control' ? 0.7 : 1)
                        })),
                        lineStyle: {
                            color: 'gradient',
                            curveness: 0.5,
                            opacity: 0.3
                        },
                        label: {
                            color: '#a0aec0',
                            fontSize: 11
                        }
                    }]
                };
                
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            },

            createMonthlyInputChart(poiId) {
                const container = document.getElementById('monthlyInputChart');
                const chart = echarts.init(container);
                const data = DataStore.generateTimeSeries(poiId, 36);
                
                const option = {
                    title: {
                        text: '36-Month Input Trend',
                        textStyle: { color: '#4FD1C5', fontSize: 14 }
                    },
                    tooltip: { trigger: 'axis' },
                    grid: { top: 40, right: 20, bottom: 30, left: 50 },
                    xAxis: {
                        type: 'category',
                        data: data.map(d => d.month),
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { 
                            color: '#a0aec0', 
                            rotate: 45,
                            interval: 5
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Tons/month',
                        nameTextStyle: { color: '#a0aec0' },
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0' },
                        splitLine: { lineStyle: { color: 'rgba(79, 209, 197, 0.1)' } }
                    },
                    series: [{
                        type: 'line',
                        data: data.map(d => d.input_tons.toFixed(0)),
                        itemStyle: { color: '#4FD1C5' },
                        areaStyle: { color: 'rgba(79, 209, 197, 0.2)' },
                        smooth: true,
                        markLine: {
                            data: [{ type: 'average', name: 'Average' }],
                            lineStyle: { color: '#ffd93d' }
                        }
                    }]
                };
                
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            },

            createRiskAssessmentChart(poiId) {
                const container = document.getElementById('riskAssessmentChart');
                const chart = echarts.init(container);
                const data = DataStore.generateTimeSeries(poiId, 12);
                
                const option = {
                    title: {
                        text: 'Risk Index Trend',
                        textStyle: { color: '#4FD1C5', fontSize: 14 }
                    },
                    tooltip: { trigger: 'axis' },
                    grid: { top: 40, right: 20, bottom: 30, left: 50 },
                    xAxis: {
                        type: 'category',
                        data: data.map(d => d.month.slice(5)),
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0' }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Risk Index',
                        min: 0,
                        max: 100,
                        nameTextStyle: { color: '#a0aec0' },
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0' },
                        splitLine: { lineStyle: { color: 'rgba(79, 209, 197, 0.1)' } }
                    },
                    series: [{
                        type: 'bar',
                        data: data.map(d => ({
                            value: d.risk_index.toFixed(0),
                            itemStyle: {
                                color: d.risk_index > 70 ? '#ff6b6b' : 
                                       d.risk_index > 40 ? '#ffd93d' : '#4FD1C5'
                            }
                        }))
                    }],
                    dataZoom: [{
                        type: 'inside',
                        start: 0,
                        end: 100
                    }]
                };
                
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            },

            createMainTrendCharts() {
                // Input Trend Chart - Store instance for updates
                this.inputChart = echarts.init(document.getElementById('inputTrendChart'));
                this.updateInputChart(); // Use the filtered data from the start
                
                // Risk Index Chart
                this.riskChart = echarts.init(document.getElementById('riskIndexChart'));
                
                const riskOption = {
                    title: {
                        text: 'Environmental Risk Assessment',
                        textStyle: { color: '#4FD1C5' }
                    },
                    tooltip: { trigger: 'axis' },
                    radar: {
                        indicator: [
                            { name: 'Fisheries Impact', max: 100 },
                            { name: 'Tourism Risk', max: 100 },
                            { name: 'Health Risk', max: 100 },
                            { name: 'Ecological Damage', max: 100 },
                            { name: 'Economic Loss', max: 100 }
                        ],
                        axisName: { color: '#a0aec0' },
                        splitLine: { lineStyle: { color: 'rgba(79, 209, 197, 0.1)' } },
                        splitArea: { areaStyle: { color: 'rgba(79, 209, 197, 0.05)' } }
                    },
                    series: [{
                        type: 'radar',
                        data: [
                            {
                                value: [72, 65, 45, 78, 68],
                                name: 'Current Risk',
                                itemStyle: { color: '#ff6b6b' },
                                areaStyle: { color: 'rgba(255, 107, 107, 0.2)' }
                            },
                            {
                                value: [55, 48, 32, 60, 50],
                                name: 'With Control',
                                itemStyle: { color: '#4FD1C5' },
                                areaStyle: { color: 'rgba(79, 209, 197, 0.2)' }
                            }
                        ]
                    }]
                };
                
                this.riskChart.setOption(riskOption);
                
                window.addEventListener('resize', () => {
                    if (this.inputChart) this.inputChart.resize();
                    if (this.riskChart) this.riskChart.resize();
                });
            },

            // Update method for filtered data
            updateInputChart() {
                if (!this.inputChart) return;
                
                const data = DataStore.getMonthlyInputs({
                    poiId: 'all',
                    months: 36,
                    plastics: MapController.activeFilters?.plastic || [],
                    sources: MapController.activeFilters?.source || []
                });
                
                const option = {
                    title: {
                        text: 'Regional Plastic Input Trends',
                        textStyle: { color: '#4FD1C5' }
                    },
                    tooltip: { trigger: 'axis' },
                    legend: {
                        data: ['Macroplastic', 'Microplastic'],
                        textStyle: { color: '#a0aec0' }
                    },
                    grid: { top: 60, right: 20, bottom: 40, left: 60 },
                    xAxis: {
                        type: 'category',
                        data: data.map(d => d.month),
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0', interval: 5 }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Tons/month',
                        nameTextStyle: { color: '#a0aec0' },
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0' },
                        splitLine: { lineStyle: { color: 'rgba(79, 209, 197, 0.1)' } }
                    },
                    series: [
                        {
                            name: 'Macroplastic',
                            type: 'line',
                            data: data.map(d => Math.round(d.macro)),
                            itemStyle: { color: '#4FD1C5' },
                            smooth: true
                        },
                        {
                            name: 'Microplastic',
                            type: 'line',
                            data: data.map(d => Math.round(d.micro)),
                            itemStyle: { color: '#81E6D9' },
                            smooth: true
                        }
                    ]
                };
                
                // Update chart without recreating it
                this.inputChart.setOption(option, false, true);
            },

            createMiniChart(elementId, poiId) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const chart = echarts.init(element);
                const data = DataStore.generateTimeSeries(poiId, 12);
                
                const option = {
                    grid: { top: 5, right: 5, bottom: 20, left: 35 },
                    xAxis: {
                        type: 'category',
                        data: data.map(d => d.month.slice(5)),
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0', fontSize: 9 }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: { lineStyle: { color: '#4FD1C5' } },
                        axisLabel: { color: '#a0aec0', fontSize: 9 },
                        splitLine: { show: false }
                    },
                    series: [{
                        type: 'line',
                        data: data.map(d => d.input_tons.toFixed(0)),
                        itemStyle: { color: '#4FD1C5' },
                        areaStyle: { color: 'rgba(79, 209, 197, 0.2)' },
                        smooth: true
                    }]
                };
                
                chart.setOption(option);
            },

            getNodeColor(nodeName) {
                const colors = {
                    'Packaging': '#ff6b6b',
                    'Textiles': '#ffd93d',
                    'Industrial': '#ff9f40',
                    'Fisheries': '#4FD1C5',
                    'River System': '#81E6D9',
                    'WWTP': '#6366f1',
                    'Direct Discharge': '#f472b6',
                    'Bay Input': '#a78bfa',
                    'Retention': '#10b981',
                    'Export to Ocean': '#ef4444'
                };
                return colors[nodeName] || '#a0aec0';
            }
        };

        // ========== UI Module ==========
        const UI = {
            filterUpdateTimer: null,
            
            initialize() {
                this.setupFilters();
                this.setupSearch();
                this.setupTimeSlider();
                this.setupScenarios();
                this.setupMetrics();
                Charts.createMainTrendCharts();
            },

            setupFilters() {
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        const type = e.target.dataset.type;
                        const value = e.target.dataset.value;
                        
                        e.target.classList.toggle('active');
                        
                        if (e.target.classList.contains('active')) {
                            MapController.activeFilters[type].push(value);
                        } else {
                            const index = MapController.activeFilters[type].indexOf(value);
                            if (index > -1) {
                                MapController.activeFilters[type].splice(index, 1);
                            }
                        }
                        
                        this.updateActiveFilters();
                        this.updateMetrics();
                        
                        // Debounced chart update (100ms delay)
                        clearTimeout(this.filterUpdateTimer);
                        this.filterUpdateTimer = setTimeout(() => {
                            if (Charts.updateInputChart) {
                                Charts.updateInputChart();
                            }
                        }, 100);
                    });
                });
            },

            setupSearch() {
                const searchInput = document.getElementById('searchInput');
                const searchResults = document.getElementById('searchResults');
                
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    searchResults.innerHTML = '';
                    
                    if (query.length < 2) {
                        searchResults.style.display = 'none';
                        return;
                    }
                    
                    const matches = DataStore.pois.filter(poi => 
                        poi.name.toLowerCase().includes(query)
                    );
                    
                    if (matches.length > 0) {
                        searchResults.style.display = 'block';
                        matches.slice(0, 5).forEach(poi => {
                            const item = document.createElement('div');
                            item.className = 'search-result';
                            item.textContent = poi.name;
                            item.addEventListener('click', () => {
                                MapController.flyToPOI(poi.id);
                                searchResults.style.display = 'none';
                                searchInput.value = '';
                            });
                            searchResults.appendChild(item);
                        });
                    } else {
                        searchResults.style.display = 'none';
                    }
                });
            },

            setupTimeSlider() {
                const slider = document.getElementById('timeSlider');
                const monthDisplay = document.getElementById('currentMonth');
                const playButton = document.getElementById('playButton');
                let isPlaying = false;
                let playInterval;
                
                const updateMonth = (value) => {
                    const date = new Date(2023, parseInt(value), 1);
                    const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                    monthDisplay.textContent = monthName;
                    MapController.currentMonth = parseInt(value);
                    this.updateMetrics();
                };
                
                slider.addEventListener('input', (e) => {
                    updateMonth(e.target.value);
                });
                
                playButton.addEventListener('click', () => {
                    isPlaying = !isPlaying;
                    playButton.textContent = isPlaying ? 'â¸' : 'â–¶';
                    
                    if (isPlaying) {
                        playInterval = setInterval(() => {
                            let value = parseInt(slider.value);
                            value = (value + 1) % 36;
                            slider.value = value;
                            updateMonth(value);
                            
                            if (value === 35) {
                                isPlaying = false;
                                playButton.textContent = 'â–¶';
                                clearInterval(playInterval);
                            }
                        }, 1000);
                    } else {
                        clearInterval(playInterval);
                    }
                });
                
                updateMonth(slider.value);
            },

            setupScenarios() {
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        MapController.scenario = e.target.dataset.scenario;
                        this.updateMetrics();
                    });
                });
            },

            setupMetrics() {
                this.updateMetrics();
                setInterval(() => this.updateMetrics(), 5000);
            },

            updateMetrics() {
                const scenarioFactors = {
                    baseline: 1,
                    wet: 1.3,
                    control: 0.7
                };
                
                const factor = scenarioFactors[MapController.scenario];
                
                document.getElementById('totalInput').textContent = 
                    (2145 * factor).toFixed(0).toLocaleString();
                document.getElementById('retentionRate').textContent = 
                    (68 - (factor - 1) * 10).toFixed(0) + '%';
                document.getElementById('exportAmount').textContent = 
                    (687 * factor).toFixed(0).toLocaleString();
                document.getElementById('riskIndex').textContent = 
                    (72 * factor).toFixed(0);
            },

            updateActiveFilters() {
                const container = document.getElementById('activeFilters');
                container.innerHTML = '';
                
                Object.keys(MapController.activeFilters).forEach(type => {
                    MapController.activeFilters[type].forEach(value => {
                        const chip = document.createElement('div');
                        chip.className = 'filter-chip active';
                        chip.textContent = value;
                        chip.style.margin = '0.25rem 0';
                        container.appendChild(chip);
                    });
                });
            }
        };
        
        // ========== Legend Module ==========
        const Legend = {
            legendItems: [
                { id: 'regulatory', label: 'Ecological Redline', color: 'rgba(255, 0, 0, 0.3)', border: '2px dashed red' },
                { id: 'fisheries', label: 'Fishing Grounds', color: 'rgba(0, 255, 0, 0.2)' },
                { id: 'wwtp', label: 'WWTP', color: 'rgba(0, 100, 255, 0.6)', shape: 'circle' },
                { id: 'industrial', label: 'Industrial Zone', color: 'rgba(255, 165, 0, 0.6)', shape: 'circle' },
                { id: 'tourism', label: 'Tourism Sites', color: '#4FD1C5', shape: 'marker' },
                { id: 'monitoring', label: 'Monitoring Stations', color: '#4FD1C5', shape: 'circle' },
                { id: 'heatmap', label: 'Concentration Heatmap', color: 'linear-gradient(90deg, rgba(79,209,197,0.4) 0%, rgba(255,107,107,0.9) 100%)' },
                { id: 'currents', label: 'Ocean Currents', color: '#81E6D9', style: 'dashed' },
                { id: 'shipping', label: 'Shipping Lanes', color: '#4FD1C5', style: 'dashed' }
            ],
            
            initialize() {
                // Set up initial legend state
                this.createLegendElements();
            },
            
            createLegendElements() {
                const legendPanel = document.querySelector('.legend-panel');
                if (!legendPanel) return;
                
                // Clear existing static legend
                const legendTitle = legendPanel.querySelector('.panel-title');
                legendPanel.innerHTML = '';
                legendPanel.appendChild(legendTitle);
                
                // Create dynamic legend items
                this.legendItems.forEach(item => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.id = `legend-${item.id}`;
                    
                    const symbol = document.createElement('div');
                    symbol.className = 'legend-symbol';
                    
                    if (item.color.includes('gradient')) {
                        symbol.style.background = item.color;
                    } else {
                        symbol.style.background = item.color;
                    }
                    
                    if (item.border) {
                        symbol.style.border = item.border;
                    }
                    
                    if (item.shape === 'circle') {
                        symbol.style.borderRadius = '50%';
                    }
                    
                    const label = document.createElement('span');
                    label.textContent = item.label;
                    label.style.transition = 'opacity 0.3s';
                    
                    legendItem.appendChild(symbol);
                    legendItem.appendChild(label);
                    legendPanel.appendChild(legendItem);
                });
            },
            
            update(visibleLayers) {
                // Update legend items based on visible layers
                this.legendItems.forEach(item => {
                    const legendElement = document.getElementById(`legend-${item.id}`);
                    if (legendElement) {
                        const label = legendElement.querySelector('span');
                        const symbol = legendElement.querySelector('.legend-symbol');
                        
                        if (visibleLayers.has(item.id)) {
                            // Layer is visible - full opacity
                            label.style.opacity = '1';
                            symbol.style.opacity = '1';
                            legendElement.style.opacity = '1';
                        } else {
                            // Layer is hidden - dim the legend item
                            label.style.opacity = '0.35';
                            symbol.style.opacity = '0.35';
                            legendElement.style.opacity = '0.5';
                        }
                    }
                });
            }
        };

        // ========== Global Functions ==========
        function showSection(sectionName) {
            // Normalize section names
            const sectionMap = {
                'dashboard': 'dashboard',
                'heatmap': 'heatmap-dashboard',
                'heatmapdashboard': 'heatmap-dashboard',
                'consulting': 'consulting',
                'consultingservice': 'consulting',
                'data-packages': 'data-packages',
                'datapackages': 'data-packages',
                'industry': 'industry',
                'industrysolutions': 'industry',
                'about': 'about',
                'aboutus': 'about'
            };
            
            const normalizedSection = sectionMap[sectionName.toLowerCase().replace(/[\s-]/g, '')] || sectionName;
            
            // Hide all sections
            document.querySelectorAll('.dashboard, .heatmap-dashboard, .consulting, .data-packages, .industry, .about').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(normalizedSection);
            if (section) {
                section.classList.add('active');
                
                if (normalizedSection === 'heatmap-dashboard' && window.HeatmapDashboard && typeof window.HeatmapDashboard.onShow === 'function') {
                    window.HeatmapDashboard.onShow();
                }
            }
        }

        function closeModal() {
            document.getElementById('mfaModal').classList.remove('active');
        }

        function toggleDrawer() {
            document.getElementById('rightDrawer').classList.toggle('open');
        }

        function downloadCSV() {
            const data = DataStore.generateTimeSeries('all', 36);
            const csv = 'Month,Input Tons,Retention Rate,Export Tons,Risk Index\n' +
                data.map(d => `${d.month},${d.input_tons},${d.retention_rate},${d.export_tons},${d.risk_index}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oceanpulse_data.csv';
            a.click();
        }

        function exportChart() {
            // Implementation for chart export
            alert('Chart export functionality - integrate with ECharts getDataURL()');
        }

        // Modal close on outside click
        document.getElementById('mfaModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ========== Initialize Application ==========
        window.addEventListener('DOMContentLoaded', () => {
            MapController.initialize();
            UI.initialize();
            ConsultingService.initialize();
            DataPackages.init();
            IndustrySolutions.initialize();
            Navigation.initialize();
            Telemetry.initialize();
        });
        
        // ========== Industry Solutions Content ==========
        const CONTENT = {
            bundles: {
                government: {
                    id: "gov-suite",
                    name: "Bay Compliance Suite",
                    icon: "ðŸ›ï¸",
                    description: "Complete regulatory compliance and monitoring solution for government agencies and park administrators",
                    outcomes: [
                        "Faster hotspot detection (< 24 hours)",
                        "Transparent public reporting",
                        "Evidence-based policy zoning"
                    ],
                    metrics: [
                        { name: "Area within limits", value: "92%", trend: "up" },
                        { name: "Incident response", value: "3.2 days", trend: "down" },
                        { name: "12-mo input trend", value: "-18%", trend: "down" }
                    ],
                    contents: [
                        "Regulatory Hotspots layer",
                        "Monthly MFA reports",
                        "Risk Index dashboard",
                        "Compliance tracking"
                    ],
                    price: 80000
                },
                fisheries: {
                    id: "fish-tour",
                    name: "Exposure & Advisory Suite",
                    icon: "ðŸŸ",
                    description: "Protect marine resources and tourism assets with real-time exposure monitoring and advisory systems",
                    outcomes: [
                        "Safer fishing seasons",
                        "Tourism beach grades (A-F)",
                        "Optimized cleanup scheduling"
                    ],
                    metrics: [
                        { name: "Exposure score", value: "Low", trend: "down" },
                        { name: "Safe days/year", value: "312", trend: "up" },
                        { name: "Cleanup ROI", value: "4.2x", trend: "up" }
                    ],
                    contents: [
                        "Sensitive area overlay",
                        "Exposure scoring API",
                        "Seasonal closure advisory",
                        "Cleanup planning tools"
                    ],
                    price: 60000
                },
                finance: {
                    id: "impact-monitor",
                    name: "Impact & Monitoring Suite",
                    icon: "ðŸ’°",
                    description: "Risk assessment and impact monitoring for financial institutions, insurers, and NGOs",
                    outcomes: [
                        "Portfolio risk screening",
                        "ESG compliance reporting",
                        "Verified impact metrics"
                    ],
                    metrics: [
                        { name: "Assets at risk", value: "$2.3M", trend: "down" },
                        { name: "Expected loss", value: "-35%", trend: "down" },
                        { name: "Impact verified", value: "98%", trend: "up" }
                    ],
                    contents: [
                        "Portfolio screening map",
                        "Before/After analytics",
                        "KPI tracking API",
                        "ESG reporting templates"
                    ],
                    price: 100000
                }
            },
            
            addons: [
                { id: "api", name: "Real-time Monitoring API", price: 1200, description: "REST API with 10,000 calls/month" },
                { id: "onsite", name: "On-site Sampling", price: 8000, description: "Quarterly field validation (4x/year)" },
                { id: "training", name: "Operations Training", price: 2500, description: "2-day workshop for up to 20 staff" },
                { id: "custom", name: "Custom Dashboard", price: 5000, description: "Branded dashboard with custom KPIs" },
                { id: "alert", name: "Alert System", price: 800, description: "SMS/Email alerts for thresholds" },
                { id: "report", name: "Executive Reports", price: 3000, description: "Monthly C-suite briefings" }
            ],
            
            examples: {
                government: [
                    { org: "Shenzhen EPA", result: "40% reduction in violations", desc: "Deployed hotspot monitoring across 200km coastline" },
                    { org: "Hong Kong Marine Parks", result: "6 new protection zones", desc: "Evidence-based zoning using MFA data" },
                    { org: "Guangdong Province", result: "$1.2M saved annually", desc: "Prevented incidents through early warning system" }
                ],
                fisheries: [
                    { org: "Pearl Bay Fisheries Co-op", result: "25% increase in safe days", desc: "Seasonal advisories reduced exposure incidents" },
                    { org: "Lantau Tourism Board", result: "A-grade beach rating", desc: "Targeted cleanup improved water quality" },
                    { org: "Zhuhai Aquaculture Assoc.", result: "â‚¬800k insurance savings", desc: "Risk reduction validated by monitoring" }
                ],
                finance: [
                    { org: "Asia Green Fund", result: "$50M green bonds issued", desc: "Verified impact metrics enabled certification" },
                    { org: "Pacific Re Insurance", result: "15% premium optimization", desc: "Risk-based pricing using exposure data" },
                    { org: "Ocean Watch NGO", result: "3x donor increase", desc: "Transparent impact reporting drove engagement" }
                ]
            }
        };
        
        // ========== Industry Solutions Module ==========
        const IndustrySolutions = {
            currentSegment: 'government',
            currentRFQStep: 1,
            selectedBundle: null,
            selectedAddons: [],
            
            initialize() {
                this.renderBundle('government');
                this.setupROICalculator();
                this.setupRFQWizard();
                this.calculateROI();
            },
            
            renderBundle(segment) {
                const container = document.getElementById('bundlesSection');
                const bundle = CONTENT.bundles[segment];
                
                if (!container) return;
                
                container.innerHTML = `
                    <div class="bundles-grid">
                        <div class="bundle-card featured">
                            <div class="bundle-icon">${bundle.icon}</div>
                            <h3 class="bundle-name">${bundle.name}</h3>
                            <p class="bundle-description">${bundle.description}</p>
                            
                            <div class="bundle-metrics">
                                ${bundle.metrics.map(m => `
                                    <div class="metric-row">
                                        <span class="metric-name">${m.name}</span>
                                        <span class="metric-value">
                                            ${m.value} 
                                            ${m.trend === 'up' ? 'â†‘' : m.trend === 'down' ? 'â†“' : ''}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="bundle-outcomes">
                                <h4 style="color: var(--teal-light); margin-bottom: 0.5rem;">Key Outcomes</h4>
                                ${bundle.outcomes.map(o => `
                                    <div class="outcome-item">${o}</div>
                                `).join('')}
                            </div>
                            
                            <div class="bundle-actions">
                                <button class="bundle-btn secondary" onclick="viewBundleDetails('${segment}')">
                                    View Details
                                </button>
                                <button class="bundle-btn secondary" onclick="tryWithYourBay('${segment}')">
                                    Try Demo
                                </button>
                                <button class="bundle-btn primary" onclick="selectBundleForRFQ('${segment}')">
                                    Request Quote
                                </button>
                            </div>
                        </div>
                        
                        <div class="bundle-card">
                            <h4 style="color: var(--teal-primary); margin-bottom: 1rem;">What's Included</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${bundle.contents.map(c => `
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);">
                                        <span style="color: var(--teal-primary); margin-right: 0.5rem;">â†’</span>
                                        ${c}
                                    </li>
                                `).join('')}
                            </ul>
                            
                            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <canvas id="bundleSparkline" width="300" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                // Draw sparkline
                this.drawSparkline();
                
                // Update examples
                this.renderExamples(segment);
            },
            
            renderExamples(segment) {
                const container = document.getElementById('examplesGrid');
                const examples = CONTENT.examples[segment];
                
                if (!container) return;
                
                container.innerHTML = examples.map(ex => `
                    <div class="example-card">
                        <div class="example-org">${ex.org}</div>
                        <div class="example-result">${ex.result}</div>
                        <div class="example-desc">${ex.desc}</div>
                    </div>
                `).join('');
            },
            
            drawSparkline() {
                const canvas = document.getElementById('bundleSparkline');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw trend line
                ctx.strokeStyle = '#4FD1C5';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const points = [];
                for (let i = 0; i < 12; i++) {
                    const x = i * 25;
                    const y = 40 - Math.sin(i * 0.5) * 20 + Math.random() * 10;
                    points.push({ x, y });
                }
                
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.stroke();
                
                // Fill area
                ctx.fillStyle = 'rgba(79, 209, 197, 0.2)';
                ctx.lineTo(points[points.length - 1].x, 80);
                ctx.lineTo(0, 80);
                ctx.closePath();
                ctx.fill();
            },
            
            setupROICalculator() {
                // Initialize with default values
                this.calculateROI();
            },
            
            calculateROI() {
                const coastline = parseFloat(document.getElementById('coastlineKm')?.value || 50);
                const incidents = parseFloat(document.getElementById('incidentsYear')?.value || 12);
                const cleanupCost = parseFloat(document.getElementById('cleanupCost')?.value || 25000);
                const valueAtRisk = parseFloat(document.getElementById('valueAtRisk')?.value || 10) * 1000000;
                
                // Get bundle price based on current segment
                const bundlePrice = CONTENT.bundles[this.currentSegment].price;
                
                // Calculate metrics
                const reductionRate = 0.5; // 50% reduction expected
                const avoidedCost = incidents * cleanupCost * reductionRate;
                const paybackMonths = Math.round((bundlePrice / (avoidedCost / 12)));
                
                // NPV calculation (3 years, 8% discount rate)
                const annualBenefit = avoidedCost - (bundlePrice / 3);
                const discountRate = 0.08;
                let npv = 0;
                for (let year = 1; year <= 3; year++) {
                    npv += annualBenefit / Math.pow(1 + discountRate, year);
                }
                
                const roi = Math.round((npv / bundlePrice) * 100);
                
                // Update display
                document.getElementById('avoidedCost').textContent = `$${avoidedCost.toLocaleString()}`;
                document.getElementById('paybackMonths').textContent = `${paybackMonths}`;
                document.getElementById('npvValue').textContent = `$${Math.round(npv).toLocaleString()}`;
                document.getElementById('roiPercent').textContent = `${roi}%`;
                
                // Draw ROI chart
                this.drawROIChart(bundlePrice, avoidedCost, npv);
            },
            
            drawROIChart(investment, annualReturn, npv) {
                const canvas = document.getElementById('roiChart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw axes
                ctx.strokeStyle = '#4FD1C5';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(40, 160);
                ctx.lineTo(360, 160);
                ctx.moveTo(40, 20);
                ctx.lineTo(40, 160);
                ctx.stroke();
                
                // Draw cumulative value line
                ctx.strokeStyle = '#4FD1C5';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                let cumulative = -investment;
                ctx.moveTo(40, 160 - (cumulative / 1000));
                
                for (let month = 1; month <= 36; month++) {
                    cumulative += annualReturn / 12;
                    const x = 40 + (month * 9);
                    const y = 160 - (cumulative / 3000);
                    ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                // Draw break-even line
                ctx.strokeStyle = '#ffd93d';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(40, 160);
                ctx.lineTo(360, 160);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Labels
                ctx.fillStyle = '#a0aec0';
                ctx.font = '12px Arial';
                ctx.fillText('Months', 350, 180);
                ctx.fillText('Value ($k)', 5, 25);
            },
            
            setupRFQWizard() {
                // Populate bundle selector
                this.renderBundleSelector();
                
                // Populate addons
                this.renderAddons();
                
                // Initialize summary
                this.updateRFQSummary();
            },
            
            renderBundleSelector() {
                const container = document.getElementById('bundleSelector');
                if (!container) return;
                
                container.innerHTML = Object.keys(CONTENT.bundles).map(key => {
                    const bundle = CONTENT.bundles[key];
                    return `
                        <div class="bundle-option" data-bundle="${key}" onclick="selectRFQBundle('${key}')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${bundle.icon}</div>
                            <div style="color: var(--teal-primary); font-weight: 600;">${bundle.name}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                                Starting at $${(bundle.price / 1000)}k
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            renderAddons() {
                const container = document.getElementById('addonGrid');
                if (!container) return;
                
                container.innerHTML = CONTENT.addons.map(addon => `
                    <div class="addon-item">
                        <input type="checkbox" class="addon-checkbox" 
                               id="addon-${addon.id}" 
                               value="${addon.id}"
                               onchange="toggleAddon('${addon.id}')">
                        <div class="addon-info">
                            <div class="addon-name">${addon.name}</div>
                            <div class="addon-price">+$${addon.price.toLocaleString()}/year</div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                ${addon.description}
                            </div>
                        </div>
                    </div>
                `).join('');
            },
            
            updateRFQSummary() {
                const container = document.getElementById('rfqSummaryContent');
                if (!container) return;
                
                let total = 0;
                let items = [];
                
                if (this.selectedBundle) {
                    const bundle = CONTENT.bundles[this.selectedBundle];
                    total += bundle.price;
                    items.push(`${bundle.name}: $${bundle.price.toLocaleString()}`);
                }
                
                this.selectedAddons.forEach(addonId => {
                    const addon = CONTENT.addons.find(a => a.id === addonId);
                    if (addon) {
                        total += addon.price;
                        items.push(`${addon.name}: $${addon.price.toLocaleString()}`);
                    }
                });
                
                container.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        ${items.map(item => `
                            <div style="padding: 0.3rem 0; color: var(--text-secondary);">
                                â†’ ${item}
                            </div>
                        `).join('')}
                    </div>
                    <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <strong style="color: var(--warning); font-size: 1.2rem;">
                            Total: $${total.toLocaleString()}/year
                        </strong>
                    </div>
                `;
            }
        };
        
        // ========== Navigation Module ==========
        const Navigation = {
            initialize() {
                this.setupHashNavigation();
                this.updateActiveTab();
                
                // Listen for hash changes
                window.addEventListener('hashchange', () => {
                    this.updateActiveTab();
                });
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key >= '1' && e.key <= '5') {
                        const sections = ['dashboard', 'consulting', 'data-packages', 'industry', 'about'];
                        this.navigateTo(sections[parseInt(e.key) - 1]);
                    }
                    // Secret telemetry shortcut: Ctrl+Shift+T
                    if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                        openTelemetryModal();
                    }
                });
            },
            
            setupHashNavigation() {
                const hash = window.location.hash.slice(1) || 'dashboard';
                this.navigateTo(hash);
            },
            
            navigateTo(section) {
                window.location.hash = section;
                showSection(section);
                Telemetry.track('navigation', section);
            },
            
            updateActiveTab() {
                const hash = window.location.hash.slice(1) || 'dashboard';
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.textContent.toLowerCase().includes(hash.replace('-', ' ').split(' ')[0])) {
                        link.classList.add('active');
                    }
                });
                showSection(hash.replace('-', ''));
            }
        };
        
        // ========== Telemetry Module (Mock) ==========
        const Telemetry = {
            events: {},
            
            initialize() {
                // Load existing telemetry from localStorage
                const saved = localStorage.getItem('oceanpulseTelemetry');
                if (saved) {
                    this.events = JSON.parse(saved);
                }
            },
            
            track(category, action, value = 1) {
                const key = `${category}_${action}`;
                if (!this.events[key]) {
                    this.events[key] = 0;
                }
                this.events[key] += value;
                
                // Save to localStorage
                localStorage.setItem('oceanpulseTelemetry', JSON.stringify(this.events));
            },
            
            getStats() {
                return Object.entries(this.events)
                    .sort((a, b) => b[1] - a[1])
                    .map(([key, count]) => ({
                        event: key.replace(/_/g, ' '),
                        count: count
                    }));
            }
        };
        
        // ========== Global Industry Solutions Functions ==========
        function switchSegment(segment) {
            // Update active segment
            document.querySelectorAll('.segment-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.dataset.segment === segment) {
                    pill.classList.add('active');
                }
            });
            
            IndustrySolutions.currentSegment = segment;
            IndustrySolutions.renderBundle(segment);
            IndustrySolutions.calculateROI();
            Telemetry.track('segment_switch', segment);
        }
        
        function viewBundleDetails(segment) {
            const bundle = CONTENT.bundles[segment];
            alert(`${bundle.name}\n\nFull Details:\n${bundle.contents.join('\n')}\n\nPrice: $${bundle.price.toLocaleString()}`);
            Telemetry.track('bundle_details', segment);
        }
        
        function tryWithYourBay(segment) {
            // Navigate to dashboard with pre-set filters
            window.location.hash = 'dashboard';
            showSection('dashboard');
            
            // Set filters based on segment
            setTimeout(() => {
                if (segment === 'government') {
                    document.getElementById('layer-regulatory').checked = true;
                } else if (segment === 'fisheries') {
                    document.getElementById('layer-fisheries').checked = true;
                } else if (segment === 'finance') {
                    document.getElementById('layer-industrial').checked = true;
                }
                
                // Fly to demo location
                if (MapController.map) {
                    MapController.flyToPOI('sz_bay');
                }
            }, 500);
            
            Telemetry.track('try_demo', segment);
        }
        
        function calculateROI() {
            IndustrySolutions.calculateROI();
        }
        
        function togglePlaybook(element) {
            const item = element.parentElement;
            item.classList.toggle('open');
            Telemetry.track('playbook_toggle', element.textContent);
        }
        
        // RFQ Wizard Functions
        let currentRFQStep = 1;
        let selectedRFQBundle = null;
        let selectedAddons = [];
        
        function selectRFQBundle(bundle) {
            document.querySelectorAll('.bundle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-bundle="${bundle}"]`).classList.add('selected');
            
            IndustrySolutions.selectedBundle = bundle;
            IndustrySolutions.updateRFQSummary();
            Telemetry.track('rfq_bundle', bundle);
        }
        
        function selectBundleForRFQ(segment) {
            // Open RFQ wizard with pre-selected bundle
            IndustrySolutions.selectedBundle = segment;
            selectRFQBundle(segment);
            
            // Scroll to RFQ section
            document.querySelector('.rfq-section').scrollIntoView({ behavior: 'smooth' });
            Telemetry.track('rfq_start', segment);
        }
        
        function toggleAddon(addonId) {
            const checkbox = document.getElementById(`addon-${addonId}`);
            if (checkbox.checked) {
                IndustrySolutions.selectedAddons.push(addonId);
            } else {
                const index = IndustrySolutions.selectedAddons.indexOf(addonId);
                if (index > -1) {
                    IndustrySolutions.selectedAddons.splice(index, 1);
                }
            }
            IndustrySolutions.updateRFQSummary();
            Telemetry.track('rfq_addon', addonId);
        }
        
        function nextRFQStep() {
            const steps = document.querySelectorAll('.rfq-step');
            
            if (currentRFQStep < 4) {
                steps[currentRFQStep - 1].classList.remove('active');
                steps[currentRFQStep].classList.add('active');
                currentRFQStep++;
                
                // Update navigation buttons
                document.querySelector('.rfq-btn.prev').style.display = 'block';
                if (currentRFQStep === 4) {
                    document.querySelector('.rfq-btn.next').style.display = 'none';
                    document.querySelector('.rfq-btn.submit').style.display = 'block';
                }
            }
        }
        
        function prevRFQStep() {
            const steps = document.querySelectorAll('.rfq-step');
            
            if (currentRFQStep > 1) {
                steps[currentRFQStep - 1].classList.remove('active');
                steps[currentRFQStep - 2].classList.add('active');
                currentRFQStep--;
                
                // Update navigation buttons
                if (currentRFQStep === 1) {
                    document.querySelector('.rfq-btn.prev').style.display = 'none';
                }
                document.querySelector('.rfq-btn.next').style.display = 'block';
                document.querySelector('.rfq-btn.submit').style.display = 'none';
            }
        }
        
        function generateRFQ() {
            const name = document.getElementById('rfqName').value;
            const org = document.getElementById('rfqOrg').value;
            const email = document.getElementById('rfqEmail').value;
            
            if (!name || !org || !email) {
                alert('Please fill in all required contact information');
                return;
            }
            
            if (!IndustrySolutions.selectedBundle) {
                alert('Please select a bundle');
                return;
            }
            
            // Generate RFQ document
            const bundle = CONTENT.bundles[IndustrySolutions.selectedBundle];
            const selectedAddonDetails = IndustrySolutions.selectedAddons.map(id => 
                CONTENT.addons.find(a => a.id === id)
            );
            
            let total = bundle.price;
            selectedAddonDetails.forEach(addon => {
                total += addon.price;
            });
            
            const rfqData = {
                id: `RFQ-${Date.now()}`,
                date: new Date().toISOString(),
                contact: { name, organization: org, email },
                bundle: bundle.name,
                addons: selectedAddonDetails.map(a => a.name),
                deployment: {
                    timeline: document.getElementById('rfqTimeline').value,
                    coverage: document.getElementById('rfqCoverage').value,
                    support: document.getElementById('rfqSupport').value
                },
                total: total,
                notes: document.getElementById('rfqNotes').value
            };
            
            // Generate HTML document
            const rfqHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>OceanPulse RFQ ${rfqData.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #4FD1C5; }
                        h2 { color: #81E6D9; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                    </style>
                </head>
                <body>
                    <h1>Request for Quote</h1>
                    <p><strong>RFQ ID:</strong> ${rfqData.id}</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    
                    <h2>Contact Information</h2>
                    <p><strong>Name:</strong> ${rfqData.contact.name}</p>
                    <p><strong>Organization:</strong> ${rfqData.contact.organization}</p>
                    <p><strong>Email:</strong> ${rfqData.contact.email}</p>
                    
                    <h2>Solution Package</h2>
                    <p><strong>Bundle:</strong> ${rfqData.bundle}</p>
                    <p><strong>Add-ons:</strong> ${rfqData.addons.join(', ') || 'None'}</p>
                    
                    <h2>Deployment Scope</h2>
                    <p><strong>Timeline:</strong> ${rfqData.deployment.timeline}</p>
                    <p><strong>Coverage:</strong> ${rfqData.deployment.coverage}</p>
                    <p><strong>Support:</strong> ${rfqData.deployment.support}</p>
                    
                    <h2>Pricing Summary</h2>
                    <table>
                        <tr><td>${bundle.name}</td><td>$${bundle.price.toLocaleString()}</td></tr>
                        ${selectedAddonDetails.map(addon => 
                            `<tr><td>${addon.name}</td><td>$${addon.price.toLocaleString()}</td></tr>`
                        ).join('')}
                        <tr style="font-weight: bold;">
                            <td>Total Annual Investment</td>
                            <td>$${total.toLocaleString()}</td>
                        </tr>
                    </table>
                    
                    ${rfqData.notes ? `
                        <h2>Additional Requirements</h2>
                        <p>${rfqData.notes}</p>
                    ` : ''}
                    
                    <h2>Next Steps</h2>
                    <ol>
                        <li>Our solutions team will review your requirements</li>
                        <li>Schedule a discovery call within 48 hours</li>
                        <li>Receive detailed proposal within 5 business days</li>
                        <li>Begin implementation upon approval</li>
                    </ol>
                    
                    <p style="margin-top: 40px;">
                        <em>Thank you for choosing OceanPulse. We look forward to partnering with you.</em>
                    </p>
                </body>
                </html>
            `;
            
            // Download as HTML file
            const blob = new Blob([rfqHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `OceanPulse_RFQ_${rfqData.id}.html`;
            a.click();
            URL.revokeObjectURL(url);
            
            Telemetry.track('rfq_generated', IndustrySolutions.selectedBundle);
            
            alert(`RFQ generated successfully!\n\nID: ${rfqData.id}\nTotal: $${total.toLocaleString()}\n\nCheck your downloads folder.`);
        }
        
        // Telemetry Functions
        function openTelemetryModal() {
            const stats = Telemetry.getStats();
            const content = document.getElementById('telemetryStats');
            
            content.innerHTML = stats.map(stat => `
                <div class="telemetry-stat">
                    <span>${stat.event}</span>
                    <span>${stat.count}</span>
                </div>
            `).join('');
            
            document.getElementById('telemetryModal').classList.add('active');
        }
        
        function closeTelemetryModal() {
            document.getElementById('telemetryModal').classList.remove('active');
        }
        
        // ========== Heatmap Dashboard Module ==========
        (function() {
            if (!document.getElementById('heatmap-dashboard')) return;
            
            const HeatmapPlastics = ["PE","PP","PET","PS","PVC","Fibers","Tire wear","Mixed"];
            const HeatmapMonths = (()=>{ const arr=[]; const start=new Date(2022,10,1); for(let i=0;i<36;i++){ const d=new Date(start.getFullYear(),start.getMonth()+i,1); arr.push(d.toISOString().slice(0,7)); } return arr; })();
            
            const HeatmapPOIS = [
                {id:"sz_bay", name:"Shenzhen Bay", lon:113.94, lat:22.49, type:"bay"},
                {id:"deep_bay", name:"Deep Bay", lon:114.03, lat:22.49, type:"bay"},
                {id:"hk_waters", name:"Hong Kong Waters", lon:114.16, lat:22.30, type:"bay"},
                {id:"gz_estuary", name:"Guangzhou Estuary", lon:113.51, lat:23.00, type:"estuary"},
                {id:"dongguan", name:"Dongguan Reach", lon:113.74, lat:23.02, type:"river"},
                {id:"foshan", name:"Foshan Reach", lon:112.99, lat:23.02, type:"river"},
                {id:"zhuhai", name:"Zhuhai Waters", lon:113.57, lat:22.27, type:"bay"},
                {id:"macao", name:"Macao Nearshore", lon:113.55, lat:22.17, type:"bay"},
                {id:"huizhou", name:"Huizhou Coast", lon:114.50, lat:22.72, type:"coast"},
                {id:"jiangmen", name:"Jiangmen Coast", lon:113.10, lat:22.59, type:"coast"},
                {id:"zhaoqing", name:"Zhaoqing Upper", lon:112.46, lat:23.05, type:"river"},
                {id:"humen", name:"Humen Strait", lon:113.60, lat:22.82, type:"strait"},
                {id:"nansha", name:"Nansha Port", lon:113.60, lat:22.67, type:"port"},
                {id:"shekou", name:"Shekou Terminal", lon:113.91, lat:22.48, type:"port"},
                {id:"yantian", name:"Yantian Port", lon:114.27, lat:22.56, type:"port"},
                {id:"shanwei", name:"Shanwei Coast", lon:115.36, lat:22.78, type:"coast"},
                {id:"heyuan", name:"Heyuan Dongjiang", lon:114.70, lat:23.73, type:"river"},
                {id:"qingyuan", name:"Qingyuan Beijiang", lon:113.13, lat:23.70, type:"river"},
                {id:"wuzhou", name:"Wuzhou Xijiang", lon:111.32, lat:23.48, type:"river"},
                {id:"gaoming", name:"Gaoming Reach", lon:112.80, lat:22.93, type:"river"},
                {id:"lianhua", name:"Lianhua Mt Coast", lon:114.12, lat:22.54, type:"coast"},
                {id:"cheungchau", name:"Cheung Chau", lon:114.02, lat:22.21, type:"island"},
                {id:"taiopo", name:"Tai Oâ€“Po Toi Lane", lon:113.90, lat:22.18, type:"lane"},
                {id:"nanpeng", name:"Nanpeng Islands", lon:115.27, lat:22.45, type:"island"},
                {id:"dapeng", name:"Dapeng Bay", lon:114.49, lat:22.57, type:"bay"},
            ];
            
            function rectPoly(lon,lat,w=0.12,h=0.06){return [[[lon,lat],[lon+w,lat],[lon+w,lat+h],[lon,lat+h],[lon,lat]]]}
            const HeatmapHotspots = {"type":"FeatureCollection","features":[
                { "type":"Feature", "geometry":{"type":"Polygon","coordinates":rectPoly(113.86,22.43)},
                    "properties":{"id":"reg-001","name":"Shenzhen Bay Ecological Redline","category":"redline","reg_text":"No discharge above Class IV; microplastic limit 0.1 g/m3","compliance_score":72}},
                { "type":"Feature", "geometry":{"type":"Polygon","coordinates":rectPoly(114.22,22.50,0.13,0.07)},
                    "properties":{"id":"reg-002","name":"Yantian Coastal Buffer","category":"buffer","reg_text":"Buffer area; heightened monitoring","compliance_score":65}},
                { "type":"Feature", "geometry":{"type":"Polygon","coordinates":rectPoly(113.53,22.86,0.18,0.08)},
                    "properties":{"id":"reg-003","name":"Humen Estuary MPA","category":"MPA","reg_text":"Marine protected area","compliance_score":81}}
            ]};
            const HeatmapFisheries = {"type":"FeatureCollection","features":[
                { "type":"Feature","geometry":{"type":"Polygon","coordinates":rectPoly(113.95,22.17,0.18,0.09)},
                    "properties":{"id":"fish-101","name":"Nei Lingding Aquaculture","species":["Oyster","Sea bass"],"season":"Aprâ€“Sep","sensitivity":0.78}},
                { "type":"Feature","geometry":{"type":"Polygon","coordinates":rectPoly(113.40,22.20,0.15,0.08)},
                    "properties":{"id":"fish-102","name":"Zhuhai Trawling Ground","species":["Mackerel"],"season":"All year","sensitivity":0.55}}
            ]};
            const HeatmapWWTP = {"type":"FeatureCollection","features":[
                {"type":"Feature","geometry":{"type":"Point","coordinates":[113.93,22.50]},"properties":{"id":"wwtp-01","name":"Shenzhen WWTP A","type":"WWTP","flow_m3d":320000,"mp_removal_eff":0.86}},
                {"type":"Feature","geometry":{"type":"Point","coordinates":[114.06,22.57]},"properties":{"id":"wwtp-02","name":"Shenzhen Outfall B","type":"Outfall","flow_m3d":90000,"mp_removal_eff":0.20}},
                {"type":"Feature","geometry":{"type":"Point","coordinates":[113.61,22.81]},"properties":{"id":"wwtp-03","name":"Guangzhou WWTP C","type":"WWTP","flow_m3d":410000,"mp_removal_eff":0.80}},
                {"type":"Feature","geometry":{"type":"Point","coordinates":[114.16,22.30]},"properties":{"id":"wwtp-04","name":"Hong Kong WWTP D","type":"WWTP","flow_m3d":350000,"mp_removal_eff":0.83}}
            ]};
            const HeatmapPorts = {"type":"FeatureCollection","features":[
                {"type":"Feature","geometry":{"type":"Point","coordinates":[113.91,22.48]},"properties":{"id":"port-01","name":"Shekou Terminal","sector":"Port"}},
                {"type":"Feature","geometry":{"type":"Point","coordinates":[114.27,22.56]},"properties":{"id":"port-02","name":"Yantian Port","sector":"Port"}},
                {"type":"Feature","geometry":{"type":"Point","coordinates":[113.60,22.67]},"properties":{"id":"port-03","name":"Nansha Port","sector":"Port"}},
                {"type":"Feature","geometry":{"type":"Point","coordinates":[113.50,23.06]},"properties":{"id":"ind-01","name":"Guangzhou Chemical Park","sector":"Industrial"}}
            ]};
            
            const HeatmapSeries = [];
            function seededRandom(seed){let x=Math.sin(seed)*10000; return x-Math.floor(x);}
            HeatmapPOIS.forEach((p,idx)=>{
                HeatmapPlastics.forEach((pl,pi)=>{
                    HeatmapMonths.forEach((m,mi)=>{
                        const base = 100 + (idx%7)*30 + (pi%5)*15;
                        const season = (m.slice(5,7)%12);
                        const wetFactor = (season>=5 && season<=9)? 1.25: 0.9;
                        const noise = 1 + (seededRandom(idx*1000+pi*100+mi)-0.5)*0.25;
                        const input = +(base*wetFactor*noise).toFixed(1);
                        const retention = +(0.5 + (seededRandom(idx+mi)*0.3)).toFixed(2);
                        const export_t = +(input*(1-retention)*0.6).toFixed(1);
                        const risk = Math.min(100, Math.round(40 + input/8 + (1-retention)*30));
                        HeatmapSeries.push({poi_id:p.id, plastic:pl, month:m, input_tons:input, retention_rate:retention, export_tons:export_t, risk_index:risk});
                    });
                    });
                });
                
            function genHeatmapSankey(poi_id, month, plasticFilter){
                const items = HeatmapSeries.filter(s=>s.poi_id===poi_id && s.month===month && (plasticFilter.size===0 || plasticFilter.has(s.plastic)));
                const totalInput = items.reduce((a,b)=>a+b.input_tons,0);
                const pkg = totalInput*0.45, tex=totalInput*0.25, ind=totalInput*0.15;
                const viaRiver=pkg*0.75 + ind*0.4, viaWWTP=tex*0.8, direct = pkg*0.25 + ind*0.6 + tex*0.2;
                const toBay = viaRiver + viaWWTP + direct;
                const retention = toBay * 0.62, exportT = toBay * 0.38;
                return {
                    nodes:["Packaging","Textiles","Industrial","River","WWTP","Direct","Bay Input","Retention","Export"],
                    links:[
                        {source:"Packaging",target:"River",value: +viaRiver.toFixed(1)},
                        {source:"Textiles",target:"WWTP",value:+viaWWTP.toFixed(1)},
                        {source:"Industrial",target:"Direct",value:+(ind*0.6).toFixed(1)},
                        {source:"River",target:"Bay Input",value:+viaRiver.toFixed(1)},
                        {source:"WWTP",target:"Bay Input",value:+viaWWTP.toFixed(1)},
                        {source:"Direct",target:"Bay Input",value:+direct.toFixed(1)},
                        {source:"Bay Input",target:"Retention",value:+retention.toFixed(1)},
                        {source:"Bay Input",target:"Export",value:+exportT.toFixed(1)}
                    ],
                    totals:{totalInput:+totalInput.toFixed(1), retention:+retention.toFixed(1), export:+exportT.toFixed(1), dominant:"Packaging"}
                };
            }
            
            function toCSV(rows){
                if(!rows.length) return "";
                const headers = Object.keys(rows[0]);
                const escape = (v)=>`"${String(v).replace(/"/g,'""')}"`;
                return [headers.join(","), ...rows.map(r=>headers.map(h=>escape(r[h])).join(","))].join("\n");
            }
            
            const plasticChips = document.getElementById('heatmapPlasticChips');
            const layerList = document.getElementById('heatmapLayerList');
            const monthLabel = document.getElementById('heatmapMonthLabel');
            const timeSlider = document.getElementById('heatmapTimeSlider');
            const search = document.getElementById('heatmapSearch');
            let heatmapPlasticFilter = new Set(); let heatmapScenario = 'baseline'; let heatmapCurrentMonthIdx = HeatmapMonths.length - 1; let heatmapSelectedPoi = HeatmapPOIS[0];
            
            HeatmapPlastics.forEach(p=>{
                const el = document.createElement('div'); el.className='chip'; el.textContent=p; el.dataset.plastic = p;
                el.onclick = ()=>{ el.classList.toggle('active'); if(el.classList.contains('active')) heatmapPlasticFilter.add(p); else heatmapPlasticFilter.delete(p); heatmapRefreshAll(); };
                plasticChips.appendChild(el);
            });
            document.querySelectorAll('#heatmap-dashboard [data-scenario]').forEach(btn=>{
                btn.onclick = ()=>{ document.querySelectorAll('#heatmap-dashboard [data-scenario]').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); heatmapScenario = btn.dataset.scenario; heatmapRefreshAll(); };
            });
            timeSlider.oninput = ()=>{ heatmapCurrentMonthIdx = +timeSlider.value; monthLabel.textContent = HeatmapMonths[heatmapCurrentMonthIdx]; heatmapRefreshAll(); };
            monthLabel.textContent = HeatmapMonths[heatmapCurrentMonthIdx];
            search.addEventListener('change', ()=>{
                const v = search.value.toLowerCase();
                const match = HeatmapPOIS.find(p=>p.name.toLowerCase().includes(v));
                if(match){ heatmapFlyToPoi(match); }
            });
            document.getElementById('heatmapResetBtn').onclick = ()=>{
                heatmapPlasticFilter.clear();
                document.querySelectorAll('#heatmap-dashboard .chip').forEach(c=>c.classList.remove('active'));
                heatmapScenario='baseline'; document.querySelectorAll('#heatmap-dashboard [data-scenario]').forEach((b,i)=>b.classList.toggle('active',i===0));
                heatmapCurrentMonthIdx = HeatmapMonths.length-1; timeSlider.value=heatmapCurrentMonthIdx; monthLabel.textContent=HeatmapMonths[heatmapCurrentMonthIdx];
                heatmapFlyToPoi(HeatmapPOIS[0]); heatmapRefreshAll();
            };
            const HeatmapLayers = [
                {id:'hotspots', name:'Regulatory Hotspots', visible:true},
                {id:'fisheries', name:'Fisheries', visible:true},
                {id:'wwtp', name:'WWTP & Outfalls', visible:true},
                {id:'ports', name:'Industrial & Ports', visible:true},
                {id:'heatmap', name:'Input Heatmap', visible:false},
            ];
            HeatmapLayers.forEach(L=>{
                const wrap=document.createElement('label'); wrap.className='layer-item';
                const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=L.visible;
                cb.onchange=()=>{ L.visible=cb.checked; heatmapSetLayerVisibility(L.id, L.visible); };
                const span=document.createElement('span'); span.textContent=L.name;
                wrap.appendChild(cb); wrap.appendChild(span); layerList.appendChild(wrap);
            });
            
            let heatmapMap = null;
            const heatmapCharts = [];
            let heatmapPopupCounter = 0;
            let heatmapMapInitialized = false;
            
            function initializeHeatmapMap() {
                if (heatmapMapInitialized) return;
                if (typeof maplibregl === 'undefined') {
                    console.warn('MapLibre GL JS failed to load for heatmap dashboard.');
                    return;
                }
                
                heatmapMapInitialized = true;
                heatmapMap = new maplibregl.Map({ container:'heatmapMap', style:'https://demotiles.maplibre.org/style.json', center:[113.9,22.5], zoom:8.4, maxPitch:60 });
                heatmapMap.addControl(new maplibregl.NavigationControl(), 'top-left');
                heatmapMap.addControl(new maplibregl.FullscreenControl(),'top-left');
                heatmapMap.addControl(new maplibregl.ScaleControl({maxWidth:120, unit:"metric"}),'bottom-left');
                
                heatmapMap.on('load', ()=>{
                    heatmapMap.addSource('heatmap-hotspots', {type:'geojson', data:HeatmapHotspots});
                    heatmapMap.addSource('heatmap-fisheries', {type:'geojson', data:HeatmapFisheries});
                    heatmapMap.addSource('heatmap-wwtp', {type:'geojson', data:HeatmapWWTP, cluster:true, clusterRadius:40});
                    heatmapMap.addSource('heatmap-ports', {type:'geojson', data:HeatmapPorts});
                    heatmapMap.addSource('heatmap-poi', {type:'geojson', data:{"type":"FeatureCollection","features":HeatmapPOIS.map(p=>({type:"Feature",geometry:{type:"Point",coordinates:[p.lon,p.lat]},properties:p}))}});
                    heatmapMap.addSource('heatmap-heat', {type:'geojson', data:{"type":"FeatureCollection","features":[]}});
                    
                    heatmapMap.addLayer({id:'heatmap-hotspots-fill', type:'fill', source:'heatmap-hotspots', paint:{
                        'fill-color':[ 'match', ['get','category'], 'redline', '#ff6b6b', 'buffer', '#ffd93d', '#6ea8ff' ], 'fill-opacity':0.22 }});
                    heatmapMap.addLayer({id:'heatmap-hotspots-line', type:'line', source:'heatmap-hotspots', paint:{
                        'line-color':[ 'match', ['get','category'], 'redline', '#ff6b6b', 'buffer', '#ffd93d', '#6ea8ff' ], 'line-dasharray':[2,2], 'line-width':2.0 }});
                    heatmapMap.addLayer({id:'heatmap-fisheries-fill', type:'fill', source:'heatmap-fisheries', paint:{ 'fill-color':'#6ea8ff', 'fill-opacity':0.18 }});
                    heatmapMap.addLayer({id:'heatmap-fisheries-line', type:'line', source:'heatmap-fisheries', paint:{'line-color':'#6ea8ff','line-width':1.2}});
                    heatmapMap.addLayer({id:'heatmap-wwtp-circle', type:'circle', source:'heatmap-wwtp', filter:['!', ['has','point_count']], paint:{
                        'circle-radius':['interpolate',['linear'],['get','flow_m3d'], 50000,4, 500000,12], 'circle-color':'#3dd2a3','circle-opacity':0.9,'circle-stroke-color':'#0a0e27','circle-stroke-width':1 }});
                    heatmapMap.addLayer({id:'heatmap-wwtp-cluster', type:'circle', source:'heatmap-wwtp', filter:['has','point_count'], paint:{
                        'circle-radius':['interpolate',['linear'],['get','point_count'], 2,10, 50,18], 'circle-color':'#25b98a','circle-opacity':0.7 }});
                    heatmapMap.addLayer({id:'heatmap-ports-circle', type:'circle', source:'heatmap-ports', paint:{ 'circle-radius':8,'circle-color':'#ffd93d','circle-stroke-color':'#0a0e27','circle-stroke-width':1.2 }});
                    heatmapMap.addLayer({id:'heatmap-poi-symbol', type:'symbol', source:'heatmap-poi', layout:{ 'text-field':['get','name'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top' }, paint:{'text-color':'#cfe1ff','text-halo-color':'#0a0e27','text-halo-width':1.2}});
                    heatmapMap.addLayer({id:'heatmap-heatmap', type:'heatmap', source:'heatmap-heat', paint:{
                        'heatmap-radius': 30, 'heatmap-intensity':1.2,
                        'heatmap-color': ['interpolate',['linear'],['heatmap-density'],
                            0,'rgba(0,0,0,0)', 0.2,'#1d6e72', 0.4,'#1aa39d', 0.6,'#4fd1c5', 0.8,'#ffd93d', 1,'#ff6b6b'] }});
                    
                    HeatmapLayers.forEach(L => heatmapSetLayerVisibility(L.id, L.visible));
                    
                    heatmapMap.on('click','heatmap-hotspots-fill', (e)=> heatmapShowFeaturePopup(e, 'hotspots'));
                    heatmapMap.on('click','heatmap-fisheries-fill', (e)=> heatmapShowFeaturePopup(e, 'fisheries'));
                    heatmapMap.on('click','heatmap-wwtp-circle', (e)=> heatmapShowFeaturePopup(e, 'wwtp'));
                    heatmapMap.on('click','heatmap-ports-circle', (e)=> heatmapShowFeaturePopup(e, 'ports'));
                    heatmapMap.on('click','heatmap-poi-symbol', (e)=>{
                        if(e.features && e.features[0]){
                            const p = e.features[0].properties;
                            heatmapSelectedPoi = HeatmapPOIS.find(x=>x.id===p.id) || heatmapSelectedPoi;
                            heatmapRefreshAll();
                            heatmapMap.flyTo({center:e.features[0].geometry.coordinates, zoom:10.2, speed:0.6});
                        }
                    });
                    heatmapRefreshAll();
                    heatmapHandleShow();
                });
            }
            
            function heatmapSetLayerVisibility(id, visible){
                if (!heatmapMap) return;
                const ids = {'hotspots':['heatmap-hotspots-fill','heatmap-hotspots-line'],'fisheries':['heatmap-fisheries-fill','heatmap-fisheries-line'],'wwtp':['heatmap-wwtp-circle','heatmap-wwtp-cluster'],'ports':['heatmap-ports-circle'],'heatmap':['heatmap-heatmap'] }[id] || [];
                ids.forEach(lId=>{ if(heatmapMap.getLayer(lId)) heatmapMap.setLayoutProperty(lId,'visibility', visible?'visible':'none'); });
            }
            function heatmapFlyToPoi(p){ heatmapSelectedPoi=p; if(heatmapMap) heatmapMap.flyTo({center:[p.lon,p.lat], zoom:10.2, speed:0.6}); }
            
            const heatmapTsChart = echarts.init(document.getElementById('heatmapTsChart'));
            const heatmapRiskChart = echarts.init(document.getElementById('heatmapRiskChart'));
            const heatmapSankeyChart = echarts.init(document.getElementById('heatmapSankeyChart'));
            heatmapCharts.push(heatmapTsChart, heatmapRiskChart, heatmapSankeyChart);
            function heatmapRefreshAll(){
                const month = HeatmapMonths[heatmapCurrentMonthIdx]; monthLabel.textContent = month;
                const factor = heatmapScenario==='wet' ? 1.25 : heatmapScenario==='control' ? 0.75 : 1.0;
                const subset = HeatmapSeries.filter(s=>s.month===month && (heatmapPlasticFilter.size===0 || heatmapPlasticFilter.has(s.plastic)));
                const poiSubset = subset.filter(s=>s.poi_id===heatmapSelectedPoi.id);
                const heatFeatures = HeatmapPOIS.map(p=>{
                    const sum = subset.filter(x=>x.poi_id===p.id).reduce((a,b)=>a+b.input_tons,0) * factor;
                    return {type:'Feature', geometry:{type:'Point', coordinates:[p.lon,p.lat]}, properties:{value:sum}};
                });
                if(heatmapMap && heatmapMap.getSource('heatmap-heat')) heatmapMap.getSource('heatmap-heat').setData({type:'FeatureCollection',features:heatFeatures});
                const s = poiSubset; const tot = s.reduce((a,b)=>a+b.input_tons,0)*factor;
                const ret = s.length? (s.reduce((a,b)=>a+b.retention_rate,0)/s.length):0.6;
                const exp = s.reduce((a,b)=>a+b.export_tons,0)*factor;
                document.getElementById('heatmapKpiInput').textContent = tot.toFixed(1);
                document.getElementById('heatmapKpiRetention').textContent = Math.round(ret*100);
                document.getElementById('heatmapKpiExport').textContent = exp.toFixed(1);
                document.getElementById('heatmapKpiSource').textContent = "Packaging";
                document.getElementById('heatmapKpiPlastic').textContent = heatmapPlasticFilter.size? Array.from(heatmapPlasticFilter).join('/') : "Mixed";
                const xs = HeatmapMonths;
                const ts = xs.map(m=> HeatmapSeries.filter(t=>t.poi_id===heatmapSelectedPoi.id && t.month===m && (heatmapPlasticFilter.size===0||heatmapPlasticFilter.has(t.plastic))).reduce((a,b)=>a+b.input_tons,0) * factor);
                const rk = xs.map(m=> { const arr=HeatmapSeries.filter(t=>t.poi_id===heatmapSelectedPoi.id && t.month===m && (heatmapPlasticFilter.size===0||heatmapPlasticFilter.has(t.plastic))); const r = arr.length? (arr.reduce((a,b)=>a+b.risk_index,0)/arr.length):50; return r; });
                heatmapTsChart.setOption({ grid:{left:30,right:12,top:10,bottom:20}, xAxis:{type:'category',data:xs,axisLabel:{color:'#9bb0da'}}, yAxis:{type:'value',axisLabel:{color:'#9bb0da'}}, series:[{type:'line',data:ts,smooth:true}] });
                heatmapRiskChart.setOption({ grid:{left:30,right:12,top:10,bottom:20}, xAxis:{type:'category',data:xs,axisLabel:{show:false}}, yAxis:{type:'value',min:0,max:100,axisLabel:{color:'#9bb0da'}}, series:[{type:'bar',data:rk}] });
                const sank = genHeatmapSankey(heatmapSelectedPoi.id, month, heatmapPlasticFilter);
                heatmapSankeyChart.setOption({ tooltip:{}, series:[{ type:'sankey', data: sank.nodes.map(n=>({name:n})), links: sank.links, emphasis:{focus:'adjacency'}, lineStyle:{color:'source',curveness:0.5} }] });
            }
            function heatmapShowFeaturePopup(e, src){
                if (!heatmapMap || !e.features || !e.features.length) return;
                const feature = e.features[0];
                const coord = feature.geometry.type === 'Point' ? feature.geometry.coordinates : [e.lngLat.lng, e.lngLat.lat];
                let html = '<div style="min-width:240px">';
                if(src==='hotspots'){
                    html += `<strong>${feature.properties.name}</strong><br/><span class="small">${feature.properties.category}</span><br/>Compliance score: <b>${feature.properties.compliance_score}</b><br/><em>${feature.properties.reg_text}</em>`;
                } else if(src==='fisheries'){
                    const rawSpecies = feature.properties.species;
                    let speciesList = [];
                    if (Array.isArray(rawSpecies)) {
                        speciesList = rawSpecies;
                    } else if (typeof rawSpecies === 'string') {
                        try {
                            const parsed = JSON.parse(rawSpecies);
                            speciesList = Array.isArray(parsed) ? parsed : rawSpecies.split(',').map(s=>s.trim()).filter(Boolean);
                        } catch (err) {
                            speciesList = rawSpecies.split(',').map(s=>s.trim()).filter(Boolean);
                        }
                    }
                    const speciesString = speciesList.length ? speciesList.join(', ') : 'â€”';
                    html += `<strong>${feature.properties.name}</strong><br/>Species: ${speciesString}<br/>Season: ${feature.properties.season}<br/>Sensitivity: ${feature.properties.sensitivity}`;
                } else if(src==='wwtp'){
                    html += `<strong>${feature.properties.name}</strong><br/>Type: ${feature.properties.type}<br/>Flow: ${Number(feature.properties.flow_m3d).toLocaleString()} mÂ³/d<br/>MP removal: ${(Number(feature.properties.mp_removal_eff)*100).toFixed(0)}%`;
                } else if(src==='ports'){
                    html += `<strong>${feature.properties.name}</strong><br/>Sector: ${feature.properties.sector}`;
                }
                const popupChartId = `heatmapPopupChart-${++heatmapPopupCounter}`;
                html += `<div id="${popupChartId}" class="popup-chart" style="width:240px;height:120px"></div></div>`;
                new maplibregl.Popup({closeButton:true}).setLngLat(coord).setHTML(html).addTo(heatmapMap);
                if (typeof echarts !== 'undefined') {
                    setTimeout(()=>{
                        const chartContainer = document.getElementById(popupChartId);
                        if (!chartContainer) return;
                        const chart = echarts.init(chartContainer);
                        const months = HeatmapMonths.slice(-12);
                        const values = months.map(()=> Math.round(50 + Math.random()*80));
                        chart.setOption({xAxis:{type:'category',data:months,axisLabel:{show:false}},yAxis:{type:'value',axisLabel:{show:false}},grid:{left:6,right:6,top:2,bottom:2},series:[{type:'line',data:values,smooth:true}]});
                    }, 30);
                }
            }
            function heatmapHandleShow(){
                const container = document.getElementById('heatmap-dashboard');
                if (!container) return;
                const isVisible = container.classList.contains('active') || container.style.display === 'block';
                if (!isVisible) return;
                if (heatmapMapInitialized && heatmapMap) {
                    heatmapMap.resize();
                }
                heatmapCharts.forEach(chart => {
                    if (chart) chart.resize();
                });
            }
            document.getElementById('heatmapDlCsv').onclick = ()=>{
                const month = HeatmapMonths[heatmapCurrentMonthIdx];
                const rows = HeatmapSeries.filter(s=>s.month===month && (heatmapPlasticFilter.size===0 || heatmapPlasticFilter.has(s.plastic)));
                const blob = new Blob([toCSV(rows)], {type:'text/csv'});
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`oceanpulse_heatmap_${month}.csv`; a.click(); URL.revokeObjectURL(url);
            };
            document.getElementById('heatmapSavePng').onclick = ()=>{
                [heatmapTsChart, heatmapRiskChart, heatmapSankeyChart].forEach((ch, i)=>{ const url = ch.getDataURL({type:'png'}); const a = document.createElement('a'); a.href=url; a.download=`heatmap_chart_${i+1}.png`; a.click(); });
            };
            heatmapRefreshAll();
            
            window.HeatmapDashboard = {
                refresh: heatmapRefreshAll,
                onShow() {
                    initializeHeatmapMap();
                    requestAnimationFrame(() => {
                        heatmapHandleShow();
                        heatmapRefreshAll();
                    });
                }
            };
            if (document.getElementById('heatmap-dashboard').classList.contains('active')) {
                initializeHeatmapMap();
                heatmapHandleShow();
            }
            window.addEventListener('resize', () => {
                requestAnimationFrame(heatmapHandleShow);
            });
        })();
        
        // ========== Consulting Service Module ==========
        const ConsultingService = {
            // Mock data for service tiers
            serviceTiers: [
                {
                    id: "rapid",
                    name: "Rapid Assessment",
                    duration: "2 weeks",
                    price: "$8kâ€“$15k",
                    deliverables: [
                        "Hotspots map with concentration estimates",
                        "Top-3 pollution sources identified",
                        "Mitigation quick-wins recommendations",
                        "Executive summary report"
                    ],
                    featured: false
                },
                {
                    id: "baseline",
                    name: "Baseline MFA",
                    duration: "6â€“8 weeks",
                    price: "$40kâ€“$70k",
                    deliverables: [
                        "Complete monthly Material Flow Analysis",
                        "Scenario analysis (3 scenarios)",
                        "Policy brief with recommendations",
                        "Stakeholder presentation",
                        "Implementation roadmap"
                    ],
                    featured: true
                },
                {
                    id: "custom",
                    name: "Custom Program",
                    duration: "Quarterly",
                    price: "$100k+",
                    deliverables: [
                        "Continuous monitoring integration",
                        "Real-time dashboard access",
                        "Quarterly MFA updates",
                        "Custom modeling & scenarios",
                        "On-site training & support",
                        "API access to data platform"
                    ],
                    featured: false
                }
            ],

            // Mock case studies data
            caseStudies: [
                {
                    id: "gov-gba",
                    title: "GBA Bay Restoration Program",
                    sector: "Government",
                    kpis: {
                        input_tpm: 1850,
                        retention_pct: 61,
                        export_tpm: 720
                    },
                    methods: ["Dynamic MFA", "Hydrodynamic proxy", "Facility survey"],
                    impact: "Prioritized 5 ecological redline zones for intervention",
                    description: "Comprehensive assessment of Pearl River Delta plastic flows leading to new regulatory framework",
                    duration: "8 weeks",
                    team_size: 5
                },
                {
                    id: "port-shenzhen",
                    title: "Shenzhen Port Risk Assessment",
                    sector: "Port Authority",
                    kpis: {
                        input_tpm: 450,
                        retention_pct: 72,
                        export_tpm: 126
                    },
                    methods: ["Source apportionment", "Shipping lane analysis", "Waste audit"],
                    impact: "40% reduction in maritime plastic waste",
                    description: "Risk screening for port operations and shipping activities",
                    duration: "4 weeks",
                    team_size: 3
                },
                {
                    id: "textile-dongguan",
                    title: "Textile Industry Effluent Control",
                    sector: "Industrial",
                    kpis: {
                        input_tpm: 280,
                        retention_pct: 85,
                        export_tpm: 42
                    },
                    methods: ["Fiber tracking", "WWTP optimization", "Supply chain analysis"],
                    impact: "Achieved 85% microfiber capture rate",
                    description: "Microfiber pollution control for textile manufacturing cluster",
                    duration: "6 weeks",
                    team_size: 4
                },
                {
                    id: "tourism-hk",
                    title: "Hong Kong Beach Protection",
                    sector: "Tourism",
                    kpis: {
                        input_tpm: 120,
                        retention_pct: 45,
                        export_tpm: 66
                    },
                    methods: ["Beach surveys", "Tourist behavior study", "Tidal modeling"],
                    impact: "Beach quality improved to Blue Flag standards",
                    description: "Tourism impact assessment and beach management strategy",
                    duration: "5 weeks",
                    team_size: 3
                },
                {
                    id: "fishery-zhuhai",
                    title: "Zhuhai Fisheries Protection",
                    sector: "Fisheries",
                    kpis: {
                        input_tpm: 380,
                        retention_pct: 55,
                        export_tpm: 171
                    },
                    methods: ["Gear marking", "Ghost net tracking", "Aquaculture assessment"],
                    impact: "30% reduction in fishing gear pollution",
                    description: "Comprehensive fisheries plastic pollution mitigation",
                    duration: "7 weeks",
                    team_size: 4
                },
                {
                    id: "finance-esg",
                    title: "ESG Investment Analysis",
                    sector: "Finance",
                    kpis: {
                        input_tpm: 950,
                        retention_pct: 68,
                        export_tpm: 304
                    },
                    methods: ["Risk modeling", "ROI analysis", "Disclosure framework"],
                    impact: "$2M green bond issuance enabled",
                    description: "Plastic risk assessment for investment portfolio",
                    duration: "3 weeks",
                    team_size: 3
                }
            ],

            currentWizardStep: 1,
            formData: {},
            selectedTimeSlot: null,

            initialize() {
                this.renderServiceTiers();
                this.renderCaseStudies();
                this.setupWizard();
                this.loadSavedProgress();
            },

            renderServiceTiers() {
                const container = document.getElementById('tiersGrid');
                if (!container) return;
                
                container.innerHTML = this.serviceTiers.map(tier => `
                    <div class="tier-card ${tier.featured ? 'featured' : ''}">
                        ${tier.featured ? '<div class="tier-badge">Most Popular</div>' : ''}
                        <h3 class="tier-name">${tier.name}</h3>
                        <div class="tier-duration">${tier.duration}</div>
                        <div class="tier-price">${tier.price}</div>
                        <ul class="tier-deliverables">
                            ${tier.deliverables.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                        <button class="cta-button" style="width: 100%;" onclick="openCalendarModal('${tier.id}')">
                            Request Scoping Call
                        </button>
                    </div>
                `).join('');
            },

            renderCaseStudies() {
                const container = document.getElementById('caseStudiesGrid');
                if (!container) return;
                
                container.innerHTML = this.caseStudies.map(study => `
                    <div class="case-card" onclick="openCaseStudy('${study.id}')">
                        <span class="case-sector">${study.sector}</span>
                        <h3 class="case-title">${study.title}</h3>
                        <div class="case-kpis">
                            <div class="kpi-item">
                                <div class="kpi-value">${study.kpis.input_tpm}</div>
                                <div class="kpi-label">tons/mo</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${study.kpis.retention_pct}%</div>
                                <div class="kpi-label">retained</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${study.kpis.export_tpm}</div>
                                <div class="kpi-label">exported</div>
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                            ${study.impact}
                        </p>
                    </div>
                `).join('');
            },

            setupWizard() {
                const form = document.getElementById('intakeForm');
                if (!form) return;
                
                // Auto-save form progress
                form.addEventListener('input', (e) => {
                    this.saveProgress();
                });
            },

            saveProgress() {
                const form = document.getElementById('intakeForm');
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    if (data[key]) {
                        if (Array.isArray(data[key])) {
                            data[key].push(value);
                        } else {
                            data[key] = [data[key], value];
                        }
                    } else {
                        data[key] = value;
                    }
                });
                localStorage.setItem('consultingFormProgress', JSON.stringify(data));
                this.formData = data;
            },

            loadSavedProgress() {
                const saved = localStorage.getItem('consultingFormProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    const form = document.getElementById('intakeForm');
                    if (!form) return;
                    
                    Object.keys(data).forEach(key => {
                        const input = form.elements[key];
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = data[key] === 'on' || data[key] === 'yes';
                            } else {
                                input.value = data[key];
                            }
                        }
                    });
                    this.formData = data;
                }
            },

            calculateLeadScore() {
                // Lead scoring algorithm
                let score = 0;
                
                // Urgency weight (w1 = 25)
                const urgencyScores = {
                    'urgent': 25,
                    'normal': 15,
                    'planning': 10,
                    'future': 5
                };
                score += urgencyScores[this.formData.timeline] || 0;
                
                // Budget weight (w2 = 30)
                const budgetScores = {
                    'low': 5,
                    'medium': 15,
                    'high': 25,
                    'enterprise': 30
                };
                score += budgetScores[this.formData.budget] || 0;
                
                // Data availability weight (w3 = 25)
                const dataSources = this.formData.data_sources;
                if (dataSources) {
                    const sourceCount = Array.isArray(dataSources) ? dataSources.length : 1;
                    score += Math.min(sourceCount * 6, 25);
                }
                
                // Stakeholder count weight (w4 = 20)
                const stakeholders = parseInt(this.formData.stakeholder_count) || 0;
                score += Math.min(stakeholders * 2, 20);
                
                return Math.min(score, 100);
            }
        };
        
        // ========== Global Consulting Functions ==========
        function nextStep() {
            const currentStep = ConsultingService.currentWizardStep;
            const wizardSteps = document.querySelectorAll('.wizard-step');
            const progressSteps = document.querySelectorAll('.progress-step');
            
            // Validate current step
            const currentInputs = wizardSteps[currentStep - 1].querySelectorAll('[required]');
            let valid = true;
            currentInputs.forEach(input => {
                if (!input.value) {
                    input.style.borderColor = '#ff6b6b';
                    valid = false;
                } else {
                    input.style.borderColor = 'rgba(79, 209, 197, 0.2)';
                }
            });
            
            if (!valid) {
                alert('Please fill in all required fields');
                return;
            }
            
            ConsultingService.saveProgress();
            
            if (currentStep < 3) {
                // Hide current step
                wizardSteps[currentStep - 1].classList.remove('active');
                progressSteps[currentStep - 1].classList.add('completed');
                
                // Show next step
                wizardSteps[currentStep].classList.add('active');
                progressSteps[currentStep].classList.add('active');
                
                ConsultingService.currentWizardStep++;
                
                // Update buttons
                document.querySelector('.wizard-btn.prev').style.display = 'block';
                if (ConsultingService.currentWizardStep === 3) {
                    document.querySelector('.wizard-btn.next').style.display = 'none';
                    document.querySelector('.wizard-btn.submit').style.display = 'block';
                }
            }
        }
        
        function prevStep() {
            const currentStep = ConsultingService.currentWizardStep;
            const wizardSteps = document.querySelectorAll('.wizard-step');
            const progressSteps = document.querySelectorAll('.progress-step');
            
            if (currentStep > 1) {
                // Hide current step
                wizardSteps[currentStep - 1].classList.remove('active');
                progressSteps[currentStep - 1].classList.remove('active');
                
                // Show previous step
                wizardSteps[currentStep - 2].classList.add('active');
                progressSteps[currentStep - 2].classList.remove('completed');
                
                ConsultingService.currentWizardStep--;
                
                // Update buttons
                if (ConsultingService.currentWizardStep === 1) {
                    document.querySelector('.wizard-btn.prev').style.display = 'none';
                }
                document.querySelector('.wizard-btn.next').style.display = 'block';
                document.querySelector('.wizard-btn.submit').style.display = 'none';
            }
        }
        
        function submitIntake() {
            ConsultingService.saveProgress();
            
            // Calculate lead score
            const score = ConsultingService.calculateLeadScore();
            
            // Determine message based on score
            let message = '';
            if (score >= 80) {
                message = "Excellent match! Your project is a high priority. Our team will contact you within 24 hours.";
            } else if (score >= 60) {
                message = "Great fit! Your project aligns well with our services. Expect to hear from us within 2-3 days.";
            } else if (score >= 40) {
                message = "Good potential! We'll review your requirements and get back to you within a week.";
            } else {
                message = "Thank you for your interest. We'll evaluate your needs and contact you if we're a good fit.";
            }
            
            // Hide form and show thank you message
            document.querySelector('.wizard-container').style.display = 'none';
            const thankYouDiv = document.getElementById('thankYouMessage');
            thankYouDiv.style.display = 'block';
            document.getElementById('leadScore').textContent = score;
            document.getElementById('leadMessage').textContent = message;
            
            // Clear saved progress
            localStorage.removeItem('consultingFormProgress');
        }
        
        function scrollToIntake() {
            document.getElementById('intakeSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function openCalendarModal(tierId) {
            document.getElementById('calendarModal').classList.add('active');
            ConsultingService.selectedTier = tierId;
        }
        
        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.remove('active');
        }
        
        function selectTimeSlot(element) {
            // Remove previous selection
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Add selection
            element.classList.add('selected');
            ConsultingService.selectedTimeSlot = element.textContent;
        }
        
        function confirmSchedule() {
            const name = document.getElementById('contactName').value;
            const email = document.getElementById('contactEmail').value;
            const phone = document.getElementById('contactPhone').value;
            
            if (!name || !email) {
                alert('Please fill in your contact information');
                return;
            }
            
            if (!ConsultingService.selectedTimeSlot) {
                alert('Please select a time slot');
                return;
            }
            
            // Mock confirmation
            alert(`Thank you ${name}! Your scoping call is scheduled for ${ConsultingService.selectedTimeSlot}. We'll send a confirmation to ${email}.`);
            closeCalendarModal();
        }
        
        function openCaseStudy(studyId) {
            const study = ConsultingService.caseStudies.find(s => s.id === studyId);
            if (!study) return;
            
            document.getElementById('caseStudyTitle').textContent = study.title;
            document.getElementById('caseStudyContent').innerHTML = `
                <div class="case-sector" style="margin-bottom: 1rem;">${study.sector}</div>
                <p style="margin-bottom: 2rem;">${study.description}</p>
                
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-value">${study.kpis.input_tpm}</div>
                        <div class="metric-label">Input (tons/month)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${study.kpis.retention_pct}%</div>
                        <div class="metric-label">Retention Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${study.kpis.export_tpm}</div>
                        <div class="metric-label">Export (tons/month)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${study.duration}</div>
                        <div class="metric-label">Duration</div>
                    </div>
                </div>
                
                <h3 style="color: var(--teal-primary); margin: 2rem 0 1rem;">Methods Applied</h3>
                <ul style="list-style: none; padding: 0;">
                    ${study.methods.map(m => `<li style="padding: 0.5rem 0; color: var(--text-secondary);">â†’ ${m}</li>`).join('')}
                </ul>
                
                <h3 style="color: var(--teal-primary); margin: 2rem 0 1rem;">Impact</h3>
                <p style="color: var(--warning); font-size: 1.1rem;">${study.impact}</p>
            `;
            
            document.getElementById('caseStudyModal').classList.add('active');
        }
        
        function closeCaseStudyModal() {
            document.getElementById('caseStudyModal').classList.remove('active');
        }
        
        function toggleFAQ(element) {
            const faqItem = element.parentElement;
            faqItem.classList.toggle('open');
        }
        
        function downloadOnePager() {
            // Create a simple HTML one-pager
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>OceanPulse Consulting Services</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #4FD1C5; }
                        h2 { color: #81E6D9; }
                        .section { margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <h1>OceanPulse - Microplastics Risk & MFA Advisory</h1>
                    
                    <div class="section">
                        <h2>Your Assessment Summary</h2>
                        <p>Lead Score: ${ConsultingService.calculateLeadScore()}/100</p>
                        <p>Organization: ${ConsultingService.formData.organization || 'Not specified'}</p>
                        <p>Region: ${ConsultingService.formData.region || 'Not specified'}</p>
                        <p>Timeline: ${ConsultingService.formData.timeline || 'Not specified'}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Our Services</h2>
                        <ul>
                            <li><strong>Rapid Assessment:</strong> 2 weeks, $8k-$15k</li>
                            <li><strong>Baseline MFA:</strong> 6-8 weeks, $40k-$70k</li>
                            <li><strong>Custom Program:</strong> Quarterly, $100k+</li>
                        </ul>
                    </div>
                    
                    <div class="section">
                        <h2>Next Steps</h2>
                        <p>1. Schedule your scoping call</p>
                        <p>2. Share your data requirements</p>
                        <p>3. Receive customized proposal</p>
                        <p>4. Begin assessment</p>
                    </div>
                    
                    <div class="section">
                        <p>Contact: consulting@oceanpulse.io | +1-555-0123</p>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'OceanPulse_Consulting_OnePager.html';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>

<script>
(function(){
  // Helpers
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  function fmtUSD(x){ return '$' + Math.round(x).toLocaleString(); }
  function blobDownload(name, content, type='text/plain'){
    const blob = new Blob([content], {type}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  // Pricing tables
  const base_by_type = { time_series: 3000, geojson_points: 2500, raster: 3500, mfa_links: 4000 };
  const license_mult = { single:1, multi:1.6, enterprise:2.4 };
  const update_mult  = { oneoff:1, quarterly:1.35, monthly:1.8 };
  const region_mult  = { city:0.7, prd:1.0, gba:1.2 };
  const discounts    = { academic:0.7, government:0.85 };
  // Catalog
  const Catalog = [
    {"sku":"GBA-MFA-TS-v1","name":"GBA Monthly Inputs (2019â€“2025)","type":"time_series",
     "coverage":"GBA (36 months)","plastics":["PE","PP","Fibers"],"version":"1.0","size_mb":48,"region":"gba","vintage":"2025Q4","rights":"commercial"},
    {"sku":"GBA-SOURCES-PT-v1","name":"Point Sources & WWTP","type":"geojson_points",
     "coverage":"PRD coastal","plastics":["Mixed"],"version":"1.1","size_mb":12,"region":"prd","vintage":"2025Q3","rights":"commercial"},
    {"sku":"CITY-RISK-RASTER-v1","name":"City Risk Raster (1km)","type":"raster",
     "coverage":"City-level tiles","plastics":["Mixed"],"version":"1.0","size_mb":220,"region":"city","vintage":"2024Q4","rights":"commercial"},
    {"sku":"GBA-MFA-LINKS-v1","name":"MFA Links (monthly)","type":"mfa_links",
     "coverage":"GBA network flows","plastics":["PE","PP","PET","PS","PVC","Fibers"],"version":"1.0","size_mb":95,"region":"gba","vintage":"2025Q4","rights":"commercial"},
    {"sku":"PRD-TIMESERIES-v2","name":"PRD Time-Series (WWTP effluent)","type":"time_series",
     "coverage":"Pearl River Delta","plastics":["Fibers","PE"],"version":"2.0","size_mb":64,"region":"prd","vintage":"2025Q2","rights":"gov"},
    {"sku":"CITY-SOURCES-PT-v1","name":"Urban Sources (GeoJSON)","type":"geojson_points",
     "coverage":"Selected Cities","plastics":["Mixed"],"version":"1.0","size_mb":18,"region":"city","vintage":"2025Q1","rights":"academic"}
  ];
  const Schemas = {
    time_series: {
      schema:`[
  {"name":"poi_id","type":"string","desc":"Point of interest id"},
  {"name":"month","type":"string","desc":"YYYY-MM"},
  {"name":"plastic","type":"string","desc":"PE/PP/PET/PS/PVC/Fibers/Mixed"},
  {"name":"input_tons","type":"number","desc":"Monthly input (tons)"},
  {"name":"retention_rate","type":"number","desc":"0-1"},
  {"name":"export_tons","type":"number","desc":"Monthly export to ocean (tons)"},
  {"name":"risk_index","type":"number","desc":"0-100"}
]`,
      sample: {"poi_id":"sz_bay","month":"2025-09","plastic":"Fibers","input_tons":312.4,"retention_rate":0.67,"export_tons":104.1,"risk_index":72}
    },
    geojson_points: {
      schema:`GeoJSON FeatureCollection with properties: id, name, type, flow_m3d (if WWTP), sector, mp_removal_eff`,
      sample: { "type":"Feature","geometry":{"type":"Point","coordinates":[113.93,22.50]},
        "properties":{"id":"wwtp-01","name":"Shenzhen WWTP A","type":"WWTP","flow_m3d":320000,"mp_removal_eff":0.86}}
    },
    raster: { schema: "Cloud-optimized GeoTIFF tiles (EPSG:4326), 1km cell value = risk index (0-100).", sample: {"tile":"/tiles/{z}/{x}/{y}.tif","stat_min":2,"stat_max":94,"mean":51.2} },
    mfa_links: { schema: "Monthly node/edge CSV: nodes(id,label,type), links(source,target,month,value_tons).", sample: {"nodes":120,"links":1320,"months":36} }
  };

  // Namespaced UI
  window.DP_UI = {
    toggleDrawer(){ document.getElementById('pricingDrawer').classList.toggle('open'); },
    showModal(id){ document.getElementById(id).classList.add('show'); },
    hideModal(id){ document.getElementById(id).classList.remove('show'); }
  };

  // Module: DataPackages
  window.DataPackages = {
    state:{ q:'', region:new Set(), product:new Set(), plastics:new Set(), vintage:new Set(), rights:new Set(),
      cart: JSON.parse(localStorage.getItem('op_cart')||'[]') },
    init(){
      if(!document.getElementById('data-packages')) return;
      // Chips
      this.mountChips('fRegion',['GBA','PRD','City'], val=>this.toggleSet('region', val.toLowerCase()));
      this.mountChips('fProduct',['Raster heatmap','GeoJSON sources','Time-series','MFA links'], val=>{
        const map = {'Raster heatmap':'raster','GeoJSON sources':'geojson_points','Time-series':'time_series','MFA links':'mfa_links'};
        this.toggleSet('product', map[val]);
      });
      this.mountChips('fPlastics',['PE','PP','PET','PS','PVC','Fibers','Tire','Mixed'], v=>this.toggleSet('plastics', v));
      this.mountChips('fVintage',['2025Q4','2025Q3','2025Q2','2025Q1','2024Q4'], v=>this.toggleSet('vintage', v));
      this.mountChips('fRights',['commercial','academic','gov'], v=>this.toggleSet('rights', v));

      // Search
      const s = document.getElementById('pkgSearch');
      if(s) s.addEventListener('input', (e)=>{ this.state.q = e.target.value.toLowerCase(); this.render(); });

      // Grid
      this.render();

      // Pricing estimator events
      ['priceRegion','priceLicense','priceUpdate','discAcademic','discGov'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.addEventListener('change', Pricing.update);
      });
      Pricing.update();
    },
    mountChips(domId, arr, onClick){
      const host = document.getElementById(domId); if(!host) return;
      arr.forEach(v=>{
        const el = document.createElement('div'); el.className='chip'; el.textContent=v;
        el.onclick = ()=>{ el.classList.toggle('active'); onClick(v); this.render(); };
        host.appendChild(el);
      });
    },
    toggleSet(key, value){ const s=this.state[key]; if(s.has(value)) s.delete(value); else s.add(value); },
    filter(items){
      return items.filter(p=>{
        if(this.state.q){
          const hay=[p.name,p.sku,p.coverage,p.type,p.version].join(' ').toLowerCase();
          if(!hay.includes(this.state.q)) return false;
        }
        if(this.state.region.size && !this.state.region.has(p.region)) return false;
        if(this.state.product.size && !this.state.product.has(p.type)) return false;
        if(this.state.plastics.size){
          const ok = p.plastics.some(x=> this.state.plastics.has(x));
          if(!ok) return false;
        }
        if(this.state.vintage.size && !this.state.vintage.has(p.vintage)) return false;
        if(this.state.rights.size && !this.state.rights.has(p.rights)) return false;
        return true;
      });
    },
    render(){
      const list = this.filter(Catalog);
      const rc = document.getElementById('resultCount'); if(rc) rc.textContent = list.length + ' results';
      const grid = document.getElementById('pkgGrid'); if(!grid) return; grid.innerHTML='';
      list.forEach(p=> grid.appendChild(this.card(p)) );
    },
    card(p){
      const el = document.createElement('div'); el.className='metric-card pkg';
      el.innerHTML = `
        <div class="inline" style="justify-content:space-between">
          <h4>${p.name}</h4><span class="badge">v${p.version}</span>
        </div>
        <div class="muted" style="color:var(--text-secondary)">${p.coverage}</div>
        <div class="inline" style="gap:.35rem;flex-wrap:wrap">
          <span class="badge">${p.sku}</span>
          <span class="badge">${p.type}</span>
          <span class="badge">Plastics: ${p.plastics.join('/')}</span>
          <span class="badge">Vintage ${p.vintage}</span>
        </div>
        <div class="preview" id="prev-${p.sku}"></div>
        <div class="pkg-actions">
          <button class="btn" onclick="DataPackages.viewSchema('${p.type}','${p.name}')">View schema</button>
          <button class="btn" onclick="DataPackages.downloadSample('${p.sku}','${p.type}')">Download sample</button>
          <button class="cta-button" onclick="DataPackages.addToCart('${p.sku}')">Add to quote</button>
        </div>`;
      // Render mini preview using ECharts (assumes echarts loaded globally)
      setTimeout(()=>{
        const box = document.getElementById('prev-'+p.sku);
        if(!box || !window.echarts) return;
        const chart = echarts.init(box);
        if(p.type==='time_series'){
          const xs = Array.from({length:12},(_,i)=>`2025-${String(i+1).padStart(2,'0')}`);
          const ys = xs.map(()=> Math.round(200+Math.random()*200));
          chart.setOption({grid:{left:30,right:10,top:10,bottom:20},xAxis:{type:'category',data:xs,axisLabel:{show:false}},yAxis:{type:'value',axisLabel:{show:false},splitLine:{show:false}},series:[{type:'line',data:ys,smooth:true}]});
        }else if(p.type==='geojson_points'){
          const ys = Array.from({length:6},()=>Math.round(10+Math.random()*30));
          chart.setOption({grid:{left:20,right:10,top:10,bottom:20},xAxis:{type:'category',data:['A','B','C','D','E','F'],axisLabel:{show:false}},yAxis:{type:'value',axisLabel:{show:false},splitLine:{show:false}},series:[{type:'bar',data:ys}]});
        }else if(p.type==='raster'){
          const ys = Array.from({length:20},()=>Math.round(30+Math.random()*70));
          chart.setOption({grid:{left:20,right:10,top:10,bottom:20},xAxis:{type:'category',data:ys.map((_,i)=>i),axisLabel:{show:false}},yAxis:{type:'value',axisLabel:{show:false},splitLine:{show:false}},series:[{type:'line',data:ys,areaStyle:{}}]});
        }else if(p.type==='mfa_links'){
          const ys = Array.from({length:8},()=>Math.round(100+Math.random()*200));
          chart.setOption({grid:{left:20,right:10,top:10,bottom:20},xAxis:{type:'category',data:['Riv','WWTP','Dir','Bay','Exp','Ret','Fish','Ind'],axisLabel:{show:false}},yAxis:{type:'value',axisLabel:{show:false},splitLine:{show:false}},series:[{type:'bar',data:ys}]});
        }
      }, 0);
      return el;
    },
    viewSchema(type, title){
      document.getElementById('schemaTitle').textContent = `${title} â€” Schema`;
      const s = Schemas[type];
      document.getElementById('schemaBody').innerHTML = `<pre><code>${s.schema}</code></pre><div style="margin-top:.5rem"><b>Sample:</b><pre><code>${JSON.stringify(s.sample, null, 2)}</code></pre></div>`;
      DP_UI.showModal('schemaModal');
    },
    downloadSample(sku, type){
      const pkg = Catalog.find(x=>x.sku===sku);
      if(!pkg) return;
      if(type==='geojson_points'){
        const feats = Array.from({length:100},(_,i)=>({"type":"Feature","geometry":{"type":"Point","coordinates":[113.5+Math.random(),22.2+Math.random()]},"properties":{"id":"pt-"+i,"name":"Station "+i,"type":"WWTP","flow_m3d":Math.round(5e4+Math.random()*4e5)}}));
        const gj = {"type":"FeatureCollection","features":feats};
        blobDownload(`${sku}_sample.geojson`, JSON.stringify(gj));
      }else{
        const header = ["poi_id","month","plastic","input_tons","retention_rate","export_tons","risk_index"];
        const rows = [header.join(",")];
        const plastics=["PE","PP","PET","PS","PVC","Fibers","Mixed"];
        for(let i=0;i<50;i++){
          const m = new Date(2022, (i%36), 1).toISOString().slice(0,7);
          const rec = ["sz_bay", m, plastics[i%plastics.length], (200+Math.random()*300).toFixed(1), (0.5+Math.random()*0.3).toFixed(2), (80+Math.random()*120).toFixed(1), Math.round(40+Math.random()*40)];
          rows.push(rec.join(","));
        }
        const csv = rows.join("\\n");
        blobDownload(`${sku}_sample.csv`, csv, 'text/csv');
      }
    },
    addToCart(sku){
      const item = Catalog.find(x=>x.sku===sku);
      if(!item) return;
      const cart = JSON.parse(localStorage.getItem('op_cart')||'[]');
      if(!cart.find(x=>x.sku===sku)) cart.push({sku:item.sku,name:item.name,type:item.type});
      localStorage.setItem('op_cart', JSON.stringify(cart));
      alert(`${item.name} added to cart`);
      Pricing.update();
    },
    clearFilters(){
      ['region','product','plastics','vintage','rights'].forEach(k=> this.state[k].clear());
      $$('#data-packages .chip').forEach(c=>c.classList.remove('active'));
      const s = document.getElementById('pkgSearch'); if(s) s.value=''; this.state.q='';
      this.render();
    }
  };

  // Pricing
  window.Pricing = {
    update(){
      const cart = JSON.parse(localStorage.getItem('op_cart')||'[]');
      const regionSel = (document.getElementById('priceRegion')||{}).value || 'gba';
      const licSel = (document.getElementById('priceLicense')||{}).value || 'single';
      const updSel = (document.getElementById('priceUpdate')||{}).value || 'oneoff';
      const isAcad = (document.getElementById('discAcademic')||{}).checked || false;
      const isGov  = (document.getElementById('discGov')||{}).checked || false;

      const base_by_type = { time_series: 3000, geojson_points: 2500, raster: 3500, mfa_links: 4000 };
      const license_mult = { single:1, multi:1.6, enterprise:2.4 };
      const update_mult  = { oneoff:1, quarterly:1.35, monthly:1.8 };
      const region_mult  = { city:0.7, prd:1.0, gba:1.2 };
      const discounts    = { academic:0.7, government:0.85 };

      const lineItems = cart.map(c=>{
        const base = base_by_type[c.type] || 2500;
        const price = base * license_mult[licSel] * update_mult[updSel] * region_mult[regionSel];
        return {sku:c.sku, name:c.name, type:c.type, price};
      });
      const subtotal = lineItems.reduce((a,b)=>a+b.price,0);
      let discount = 0;
      if(isAcad) discount = Math.max(discount, 1 - discounts.academic);
      if(isGov)  discount = Math.max(discount, 1 - discounts.government);
      const total = subtotal * (1 - discount);

      const host = document.getElementById('priceBreak');
      if(host){
        host.innerHTML = lineItems.length? lineItems.map(li=>`<div class="kv"><span>${li.name}</span><span>${fmtUSD(li.price)}</span></div>`).join('') : '<div class="muted">Add packages to your quote to estimate pricing.</div>';
        host.innerHTML += `<div class="dp-sep"></div><div class="kv"><span>Subtotal</span><span>${fmtUSD(subtotal)}</span></div>`;
        host.innerHTML += `<div class="kv"><span>Discount</span><span>${discount? Math.round(discount*100)+'%':''}</span></div>`;
      }
      const totalEl = document.getElementById('priceTotal'); if(totalEl) totalEl.textContent = fmtUSD(total);
    }
  };

  // Quote
  window.Quote = {
    open(){ this.renderCart(); DP_UI.showModal('quoteModal'); },
    renderCart(){
      const cart = JSON.parse(localStorage.getItem('op_cart')||'[]');
      const host = document.getElementById('cartItems'); if(!host) return; host.innerHTML='';
      if(!cart.length){ host.innerHTML = '<div class="muted">Your cart is empty.</div>'; return; }
      cart.forEach(c=>{
        const row = document.createElement('div'); row.className='cart-row';
        row.innerHTML = `<div>${c.name} <span class="badge">${c.sku}</span></div>
          <div class="badge">${c.type}</div>
          <button class="btn" onclick="Quote.remove('${c.sku}')">Remove</button>`;
        host.appendChild(row);
      });
    },
    remove(sku){
      const cart = JSON.parse(localStorage.getItem('op_cart')||'[]').filter(x=>x.sku!==sku);
      localStorage.setItem('op_cart', JSON.stringify(cart));
      this.renderCart(); Pricing.update();
    },
    generate(){
      const email = (document.getElementById('quoteEmail')||{}).value?.trim() || '';
      const org = (document.getElementById('quoteCompany')||{}).value?.trim() || '';
      const ok = email.includes('@') && org && (document.getElementById('acceptTou')||{}).checked;
      const msg = document.getElementById('quoteMsg');
      if(!ok){ if(msg) msg.textContent = 'Please enter email, organization and accept Terms.'; return; }

      const cart = JSON.parse(localStorage.getItem('op_cart')||'[]');
      const regionSel = (document.getElementById('priceRegion')||{}).value || 'gba';
      const licSel = (document.getElementById('priceLicense')||{}).value || 'single';
      const updSel = (document.getElementById('priceUpdate')||{}).value || 'oneoff';
      const total = (document.getElementById('priceTotal')||{}).textContent || '$0';

      const html = `<!doctype html><meta charset="utf-8"><title>OceanPulse Quote</title>
      <style>body{font-family:Arial;margin:24px} h1{color:#0a0e27} h2{color:#0a0e27} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:8px} th{background:#f2f2f2}</style>
      <h1>OceanPulse â€” Data Packages Quote</h1>
      <p><b>To:</b> ${org} (${email})</p>
      <p><b>License:</b> ${licSel} Â· <b>Updates:</b> ${updSel} Â· <b>Region:</b> ${regionSel}</p>
      <table><tr><th>SKU</th><th>Name</th><th>Type</th></tr>
      ${cart.map(c=>`<tr><td>${c.sku}</td><td>${c.name}</td><td>${c.type}</td></tr>`).join('')}
      </table>
      <h2>Total Estimate: ${total}</h2>
      <p>Notes: Mock quote for evaluation. Pricing subject to final scoping and applicable discounts.</p>`;
      blobDownload('OceanPulse_Quote.html', html, 'text/html');
      if(msg) msg.textContent = 'Quote generated â€” check your downloads.';
    }
  };

  // Init on load and when tab is clicked
  document.addEventListener('DOMContentLoaded', ()=>{ if(document.getElementById('data-packages')) DataPackages.init(); });
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.classList && t.classList.contains('nav-link') && /data packages/i.test(t.textContent||'')){
      setTimeout(()=>{ if(window.DataPackages) DataPackages.render(); }, 0);
    }
  });
})();
    </script>
</body>
</html>